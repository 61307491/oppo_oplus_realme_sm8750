name: Build Custom Kernel with LXC/Docker Support

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU Type'
        type: choice
        required: true
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksu'
          - 'mksu'
      lxc_docker:
        description: 'Enable LXC/Docker Support'
        type: boolean
        required: true
        default: false
      kernel_version:
        description: 'Kernel Version'
        type: string
        required: true
        default: '6.6.89'

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          git \
          wget \
          curl \
          unzip \
          zip \
          python3
        
    - name: Create Workspace
      run: |
        mkdir -p kernel-build
        cd kernel-build
        
    - name: Download Kernel Source
      run: |
        cd kernel-build
        echo "Downloading kernel source..."
        # 这里替换为你的实际内核源码URL
        wget -q https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/main.zip -O kernel.zip || true
        if [ -f kernel.zip ]; then
          unzip -q kernel.zip
        else
          # 备用下载方式
          git clone --depth=1 https://github.com/cctv18/android_kernel_common_oneplus_sm8750.git
          mv android_kernel_common_oneplus_sm8750 common
        fi
        
    - name: Configure Kernel
      run: |
        cd kernel-build
        if [ -d "common" ]; then
          cd common
        else
          # 如果目录结构不同，进行调整
          cd android_kernel_common_oneplus_sm8750-* || exit 1
        fi
        
        # 创建或修改defconfig文件
        CONFIG_FILE="arch/arm64/configs/gki_defconfig"
        
        # 确保配置文件存在
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "Config file not found, creating..."
          make ARCH=arm64 gki_defconfig
        fi
        
        # 添加基础配置
        echo "CONFIG_KSU=y" >> "$CONFIG_FILE"
        
        # 添加LXC/Docker支持
        if [ "${{ github.event.inputs.lxc_docker }}" == "true" ]; then
          echo "Adding LXC/Docker support..."
          
          # 容器命名空间支持
          echo "CONFIG_NAMESPACES=y" >> "$CONFIG_FILE"
          echo "CONFIG_USER_NS=y" >> "$CONFIG_FILE"
          echo "CONFIG_PID_NS=y" >> "$CONFIG_FILE"
          echo "CONFIG_NET_NS=y" >> "$CONFIG_FILE"
          echo "CONFIG_UTS_NS=y" >> "$CONFIG_FILE"
          echo "CONFIG_IPC_NS=y" >> "$CONFIG_FILE"
          
          # Cgroups支持
          echo "CONFIG_CGROUPS=y" >> "$CONFIG_FILE"
          echo "CONFIG_CGROUP_CPUACCT=y" >> "$CONFIG_FILE"
          echo "CONFIG_CGROUP_DEVICE=y" >> "$CONFIG_FILE"
          echo "CONFIG_CGROUP_FREEZER=y" >> "$CONFIG_FILE"
          echo "CONFIG_CGROUP_SCHED=y" >> "$CONFIG_FILE"
          echo "CONFIG_CPUSETS=y" >> "$CONFIG_FILE"
          echo "CONFIG_MEMCG=y" >> "$CONFIG_FILE"
          
          # 网络虚拟化
          echo "CONFIG_VETH=y" >> "$CONFIG_FILE"
          echo "CONFIG_BRIDGE=y" >> "$CONFIG_FILE"
          echo "CONFIG_BRIDGE_NETFILTER=y" >> "$CONFIG_FILE"
          
          # 存储支持
          echo "CONFIG_OVERLAY_FS=y" >> "$CONFIG_FILE"
          echo "CONFIG_BLK_DEV_DM=y" >> "$CONFIG_FILE"
          
          # 其他必要配置
          echo "CONFIG_TUN=y" >> "$CONFIG_FILE"
          echo "CONFIG_BINFMT_MISC=y" >> "$CONFIG_FILE"
          echo "CONFIG_SECCOMP=y" >> "$CONFIG_FILE"
          echo "CONFIG_SECCOMP_FILTER=y" >> "$CONFIG_FILE"
          
          echo "LXC/Docker support added!"
        fi
        
        echo "Kernel configuration completed!"
        
    - name: Compile Kernel
      run: |
        cd kernel-build
        if [ -d "common" ]; then
          cd common
        else
          cd android_kernel_common_oneplus_sm8750-* || exit 1
        fi
        
        # 设置编译环境变量
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # 配置内核
        echo "Configuring kernel..."
        make gki_defconfig
        
        # 编译内核（简化版，只编译Image）
        echo "Compiling kernel..."
        make -j$(nproc) Image || make Image
        
        # 检查编译结果
        if [ -f "arch/arm64/boot/Image" ]; then
          echo "Kernel compiled successfully!"
          ls -lh arch/arm64/boot/Image
        else
          echo "Kernel compilation failed!"
          echo "Available files in arch/arm64/boot/:"
          ls -la arch/arm64/boot/ || true
          exit 1
        fi
        
    - name: Create Flashable ZIP
      run: |
        cd kernel-build
        if [ -d "common" ]; then
          cd common
          KERNEL_IMAGE="arch/arm64/boot/Image"
        else
          cd android_kernel_common_oneplus_sm8750-*
          KERNEL_IMAGE="arch/arm64/boot/Image"
        fi
        
        # 创建AnyKernel目录
        mkdir -p anykernel
        
        # 创建刷机脚本
        cat > anykernel/anykernel.sh << 'EOF'
#!/bin/bash

# AnyKernel3 Ramdisk Mod Script
# osm0sis @ xda-developers

## AnyKernel setup
# begin properties
properties() { '
kernel.string=Custom Kernel
do.devicecheck=0
do.modules=0
do.systemless=1
do.cleanup=1
do.cleanuponabort=0
device.name1=
'; } # end properties

# shell variables
block=/dev/block/bootdevice/by-name/boot;
is_slot_device=0;
ramdisk_compression=auto;

## AnyKernel methods (DO NOT CHANGE)
# import patching functions/variables - see for reference
. tools/ak3-core.sh;

## AnyKernel install
dump_boot;

write_boot;
## end install
EOF
        
        # 创建核心工具文件
        mkdir -p anykernel/tools
        cat > anykernel/tools/ak3-core.sh << 'EOF'
# AnyKernel3 Core
#!/bin/bash

# set up working directory
bin=$tmpdir/bin;
bindir=$bin;
patch=$tmpdir/patch;
ramdisk=$tmpdir/ramdisk;
split_img=$tmpdir/split_img;

chmod -R 755 $bin;
rm -rf $ramdisk $split_img;
mkdir $ramdisk $split_img;

OUTFD=$1;
KERNEL=$2;

# ui_print <text>
ui_print() { echo -e "ui_print $1\nui_print" > /proc/self/fd/$OUTFD; }

# contains <string> <substring>
contains() { [ "${1#*$2}" != "$1" ]; }

# file_getprop <file> <property>
file_getprop() { grep "^$2=" "$1" | cut -d= -f2-; }

# dump boot and extract ramdisk
dump_boot() {
  dd if=$block of=$split_img/boot.img;
  $bin/unpackbootimg -i $split_img/boot.img -o $split_img;
  
  if [ -f "$split_img/boot.img-ramdisk.gz" ]; then
    mv $split_img/boot.img-ramdisk.gz $split_img/ramdisk.gz;
    gunzip -c $split_img/ramdisk.gz | cpio -i;
  fi
}

# write boot and repack ramdisk
write_boot() {
  cd $ramdisk;
  find . | cpio -H newc -o | gzip > $split_img/ramdisk-new.gz;
  
  $bin/mkbootimg \
    --kernel $KERNEL \
    --ramdisk $split_img/ramdisk-new.gz \
    --cmdline "$(cat $split_img/boot.img-cmdline)" \
    --base $(cat $split_img/boot.img-base) \
    --pagesize $(cat $split_img/boot.img-pagesize) \
    --ramdisk_offset $(cat $split_img/boot.img-ramdiskoff) \
    --tags_offset $(cat $split_img/boot.img-tagsoff) \
    --output $split_img/boot-new.img;
    
  dd if=$split_img/boot-new.img of=$block;
}
EOF
        
        # 复制内核镜像
        cp "$KERNEL_IMAGE" anykernel/Image
        
        # 下载必要的工具
        cd anykernel/tools
        wget -q https://github.com/osm0sis/mkbootimg/raw/master/mkbootimg
        wget -q https://github.com/osm0sis/mkbootimg/raw/master/unpackbootimg
        chmod +x mkbootimg unpackbootimg
        cd ../..
        
        # 打包
        cd anykernel
        zip -r9 kernel.zip ./*
        mv kernel.zip ../custom-kernel-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.ksu_type }}.zip
        cd ..
        
        echo "Flashable ZIP created!"
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: custom-kernel
        path: kernel-build/custom-kernel-*.zip
        
    - name: Display Build Summary
      run: |
        echo "========================================="
        echo "         BUILD COMPLETED SUCCESSFULLY    "
        echo "========================================="
        echo "Kernel Version: ${{ github.event.inputs.kernel_version }}"
        echo "KernelSU Type: ${{ github.event.inputs.ksu_type }}"
        echo "LXC/Docker Support: ${{ github.event.inputs.lxc_docker }}"
        echo "Build Time: $(date)"
        echo "========================================="