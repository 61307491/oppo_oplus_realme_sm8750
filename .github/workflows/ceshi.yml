name: ä¸€åŠ 13å†…æ ¸å¼€å¯LXCæ”¯æŒ - LLVM-Clang18 ç¼–è¯‘ç‰ˆ
on:
  # è§¦å‘æ¡ä»¶ï¼š1. æ¨é€ä»£ç åˆ° main åˆ†æ”¯ï¼›2. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒé€‰æ‹©å†…æ ¸åˆ†æ”¯ï¼‰
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'å†…æ ¸åˆ†æ”¯ï¼ˆé»˜è®¤ï¼šoneplus/sm8750_6.6 ç¨³å®šç‰ˆï¼‰'
        required: true
        default: 'oneplus/sm8750_6.6'
        type: string

jobs:
  build_lxc_kernel:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04ï¼ˆå®‰å“å†…æ ¸ç¼–è¯‘æœ€ä¼˜é€‰æ‹©ï¼‰
    runs-on: ubuntu-22.04
    env:
      # å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹ï¼‰
      DEFCONFIG: vendor/sm8750-perf_defconfig
      KERNEL_REPO: https://github.com/OnePlusOSS/android_kernel_oneplus_sm8750.git
      LXC_PATCH_URL: https://raw.githubusercontent.com/yangxiaohua2009/lxc-android-kernel-patches/main/op13_sm8750_lxc.patch
      # LLVM-Clang18 å·¥å…·é“¾é…ç½®ï¼ˆé€‚é… SM8750/SM8650 èŠ¯ç‰‡ç»„ï¼‰
      CLANG_DIR: ./clang18
      BUILD_TOOLS_DIR: ./build-tools
      # å·¥å…·é“¾ä¸‹è½½åœ°å€ï¼ˆå¤šçº¿ç¨‹åŠ é€Ÿï¼Œå·²éªŒè¯é“¾æ¥æœ‰æ•ˆï¼‰
      CLANG_URL: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip"
      BUILD_TOOLS_URL: "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip"

    steps:
      ##########################################################################
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆæµ…å…‹éš†ï¼Œæé€Ÿï¼‰
      ##########################################################################
      - name: æ£€å‡ºåŸºç¡€ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      ##########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆLLVM-Clang ä¾èµ– + å†…æ ¸ç¼–è¯‘å·¥å…·ï¼‰
      ##########################################################################
      - name: å®‰è£…Ubuntuç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y > /dev/null 2>&1
          sudo apt install -y \
            git bc bison flex libssl-dev libelf-dev lz4 zstd curl patch aria2 \
            python3 python3-pip > /dev/null 2>&1
          echo -e "\033[32mâœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆï¼ˆå« aria2 å¤šçº¿ç¨‹ä¸‹è½½å·¥å…·ï¼‰\033[0m"

      ##########################################################################
      # æ­¥éª¤3ï¼šä¸‹è½½ LLVM-Clang18 å·¥å…·é“¾ + æ„å»ºå·¥å…·ï¼ˆå¹¶è¡ŒåŠ é€Ÿ + å®Œæ•´æ€§æ ¡éªŒï¼‰
      ##########################################################################
      - name: ä¸‹è½½å¹¶è§£å‹ LLVM-Clang18 å·¥å…·é“¾åŠæ„å»ºå·¥å…·
        run: |
          # åˆ›å»ºå·¥å…·é“¾å’Œæ„å»ºå·¥å…·ç›®å½•
          mkdir -p "${CLANG_DIR}" "${BUILD_TOOLS_DIR}"
          echo -e "\033[32mğŸ”½ å¹¶è¡Œä¸‹è½½ LLVM-Clang18 å·¥å…·é“¾å’Œæ„å»ºå·¥å…·ï¼ˆå¤šçº¿ç¨‹åŠ é€Ÿï¼‰...\033[0m"

          # å¹¶è¡Œåå°ä¸‹è½½ï¼ˆ16çº¿ç¨‹ï¼Œæå‡é€Ÿåº¦ï¼‰ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆ
          aria2c -s16 -x16 -k1M -q "${CLANG_URL}" -o clang.zip &
          aria2c -s16 -x16 -k1M -q "${BUILD_TOOLS_URL}" -o build-tools.zip &
          wait  # å…³é”®ï¼šç¡®ä¿ä¸¤ä¸ªä¸‹è½½ä»»åŠ¡å®Œå…¨å®Œæˆåå†æ‰§è¡Œåç»­æ­¥éª¤

          # æ ¡éªŒä¸‹è½½æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…ä¸‹è½½ä¸­æ–­å¯¼è‡´æ–‡ä»¶ç¼ºå¤±ï¼‰
          if [ ! -f "clang.zip" ] || [ ! -f "build-tools.zip" ]; then
            echo -e "\033[31mâŒ å·¥å…·é“¾æˆ–æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥ï¼Œæ–‡ä»¶ç¼ºå¤±ï¼\033[0m"
            exit 1
          fi

          # è§£å‹ LLVM-Clang18 å·¥å…·é“¾ï¼ˆé™é»˜è§£å‹ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
          echo -e "\033[32mğŸ“¦ è§£å‹ LLVM-Clang18 å·¥å…·é“¾...\033[0m"
          unzip -q clang.zip -d "${CLANG_DIR}" || {
            echo -e "\033[31mâŒ å·¥å…·é“¾å‹ç¼©åŒ…æŸåï¼Œè§£å‹å¤±è´¥ï¼\033[0m"
            exit 1
          }

          # è§£å‹æ„å»ºå·¥å…·ï¼ˆé™é»˜è§£å‹ï¼‰
          echo -e "\033[32mğŸ“¦ è§£å‹æ„å»ºå·¥å…·...\033[0m"
          unzip -q build-tools.zip -d "${BUILD_TOOLS_DIR}" || {
            echo -e "\033[31mâŒ æ„å»ºå·¥å…·å‹ç¼©åŒ…æŸåï¼Œè§£å‹å¤±è´¥ï¼\033[0m"
            exit 1
          }

          # æ¸…ç†å‹ç¼©åŒ…ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
          rm -rf clang.zip build-tools.zip

          # é…ç½®å·¥å…·é“¾è·¯å¾„å¹¶å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          export CLANG_PATH=$(pwd)/"${CLANG_DIR}"/bin
          echo "CLANG_PATH=${CLANG_PATH}" >> $GITHUB_ENV
          # é…ç½®æ„å»ºå·¥å…·è·¯å¾„ï¼ˆéƒ¨åˆ†å†…æ ¸ç¼–è¯‘ä¾èµ–ï¼‰
          export PATH=$(pwd)/"${BUILD_TOOLS_DIR}"/bin:$PATH
          echo "PATH=${PATH}" >> $GITHUB_ENV

          # éªŒè¯å·¥å…·é“¾å¯ç”¨æ€§ï¼ˆæœ€å¯é çš„æ ¡éªŒæ–¹å¼ï¼‰
          echo -e "\033[32mâœ… éªŒè¯ LLVM-Clang18 å·¥å…·é“¾ç‰ˆæœ¬...\033[0m"
          if [ ! -f "${CLANG_PATH}/clang" ]; then
            echo -e "\033[31mâŒ æœªæ‰¾åˆ° Clang å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå·¥å…·é“¾è§£å‹ä¸å®Œæ•´ï¼\033[0m"
            exit 1
          fi
          # è·å–å®é™…å·¥å…·é“¾ç‰ˆæœ¬å¹¶è¾“å‡º
          CLANG_ACTUAL_VERSION=$(${CLANG_PATH}/clang --version | head -n1 | awk '{print $3}')
          echo -e "\033[32mâœ… LLVM-Clang18 å·¥å…·é“¾å‡†å¤‡å®Œæˆï¼ˆå®é™…ç‰ˆæœ¬ï¼š${CLANG_ACTUAL_VERSION}ï¼‰\033[0m"
        shell: bash
        timeout-minutes: 15  # å·¥å…·é“¾ä¸‹è½½+è§£å‹è¶…æ—¶ï¼ˆ15åˆ†é’Ÿè¶³å¤Ÿï¼‰

      ##########################################################################
      # æ­¥éª¤4ï¼šæ‹‰å–ä¸€åŠ 13å®˜æ–¹å†…æ ¸æºç ï¼ˆå·²éªŒè¯åˆ†æ”¯å­˜åœ¨ï¼‰
      ##########################################################################
      - name: æ‹‰å–ä¸€åŠ 13å†…æ ¸æºç 
        run: |
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'oneplus/sm8750_6.6' }}"
          echo -e "\033[32mğŸ“¥ æ‹‰å–å†…æ ¸æºç ï¼ˆåˆ†æ”¯ï¼š${KERNEL_BRANCH}ï¼‰...\033[0m"
          # å…‹éš†æŒ‡å®šåˆ†æ”¯ï¼Œæµ…å…‹éš†æé€Ÿï¼ˆä»…æ‹‰å–æœ€æ–°ä»£ç ï¼‰
          git clone -b "${KERNEL_BRANCH}" --depth 1 "${KERNEL_REPO}" ./op13_kernel
          cd ./op13_kernel
          # éªŒè¯å½“å‰åˆ†æ”¯æ˜¯å¦æ­£ç¡®ï¼Œé¿å…æ‹‰å–é”™è¯¯
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "${CURRENT_BRANCH}" != "${KERNEL_BRANCH}" ]; then
            echo -e "\033[31mâŒ å†…æ ¸åˆ†æ”¯æ‹‰å–é”™è¯¯ï¼Œå®é™…åˆ†æ”¯ï¼š${CURRENT_BRANCH}\033[0m"
            exit 1
          fi
          echo -e "\033[32mâœ… å†…æ ¸æºç æ‹‰å–å®Œæˆï¼Œå½“å‰åˆ†æ”¯ï¼š${CURRENT_BRANCH}\033[0m"
        shell: bash
        timeout-minutes: 5

      ##########################################################################
      # æ­¥éª¤5ï¼šä¸‹è½½å¹¶åº”ç”¨LXCæ”¯æŒè¡¥ä¸ï¼ˆå…ˆæµ‹è¯•æ— å†²çªï¼Œå†åº”ç”¨ï¼‰
      ##########################################################################
      - name: åº”ç”¨LXCæ”¯æŒè¡¥ä¸
        run: |
          cd ./op13_kernel
          echo -e "\033[32mğŸ“¥ ä¸‹è½½LXCæ”¯æŒè¡¥ä¸...\033[0m"
          # è¡¥ä¸ä¸‹è½½æ·»åŠ é‡è¯•ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨å¯¼è‡´å¤±è´¥
          curl -L --progress-bar --retry 3 "${LXC_PATCH_URL}" -o lxc_support.patch

          echo -e "\033[32mğŸ” æµ‹è¯•è¡¥ä¸å…¼å®¹æ€§ï¼ˆæ— å†²çªå†åº”ç”¨ï¼‰...\033[0m"
          if patch -p1 --dry-run < lxc_support.patch > /dev/null 2>&1; then
            echo -e "\033[32mâœ… è¡¥ä¸æ— å†²çªï¼Œå¼€å§‹åº”ç”¨...\033[0m"
            patch -p1 < lxc_support.patch
            echo -e "\033[32mâœ… LXCè¡¥ä¸åº”ç”¨å®Œæˆ\033[0m"
          else
            echo -e "\033[31mâŒ è¡¥ä¸åº”ç”¨å†²çªï¼Œè¯·æ£€æŸ¥è¡¥ä¸ä¸å†…æ ¸åˆ†æ”¯å…¼å®¹æ€§ï¼\033[0m"
            # è¾“å‡ºå†²çªè¯¦æƒ…ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
            patch -p1 --dry-run < lxc_support.patch
            exit 1
          fi
        shell: bash
        timeout-minutes: 3

      ##########################################################################
      # æ­¥éª¤6ï¼šé…ç½®ç¼–è¯‘ç¯å¢ƒå¹¶ç¼–è¯‘å†…æ ¸ï¼ˆLLVM-Clang18 + LXCæ”¯æŒï¼‰
      ##########################################################################
      - name: é…ç½®å¹¶ç¼–è¯‘å†…æ ¸
        run: |
          cd ./op13_kernel
          # å¯¼å…¥ LLVM-Clang18 å·¥å…·é“¾è·¯å¾„
          CLANG_PATH="${{ env.CLANG_PATH }}"

          # é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡ï¼ˆé€‚é… LLVM-Clang18 + SM8750 èŠ¯ç‰‡ç»„ï¼‰
          export ARCH=arm64
          export SUBARCH=arm64
          export CC="${CLANG_PATH}/clang"
          export CXX="${CLANG_PATH}/clang++"
          export LD="${CLANG_PATH}/ld.lld"
          export AR="${CLANG_PATH}/llvm-ar"
          export NM="${CLANG_PATH}/llvm-nm"
          export OBJCOPY="${CLANG_PATH}/llvm-objcopy"
          export OBJDUMP="${CLANG_PATH}/llvm-objdump"
          export STRIP="${CLANG_PATH}/llvm-strip"
          # å…³é”®ï¼šSM8750 å†…æ ¸ç¼–è¯‘å¿…éœ€çš„äº¤å‰ç¼–è¯‘å‰ç¼€
          export CROSS_COMPILE="${CLANG_PATH}/aarch64-linux-gnu-"
          export CROSS_COMPILE_ARM32="${CLANG_PATH}/arm-linux-gnueabi-"
          # ä¼˜åŒ–ç¼–è¯‘å‚æ•°ï¼ˆå‡å°‘è­¦å‘Šï¼Œæå‡å…¼å®¹æ€§ï¼‰
          export KCFLAGS="-w"

          echo -e "\033[32mâš™ï¸  åŠ è½½å®˜æ–¹é…ç½®å¹¶åˆå¹¶LXCåŠŸèƒ½é…ç½®...\033[0m"
          # åŠ è½½ä¸€åŠ 13å®˜æ–¹æ€§èƒ½ç‰ˆé…ç½®
          make O=./build "${DEFCONFIG}"
          # è‡ªåŠ¨åˆå¹¶ LXC ç›¸å…³é…ç½®ï¼ˆé¿å…æ‰‹åŠ¨ä¿®æ”¹å†²çªï¼‰
          make O=./build olddefconfig 2>&1 | grep -E "CONFIG_|#" || true

          echo -e "\033[32mğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆCPUæ ¸å¿ƒæ•°ï¼š$(nproc)ï¼Œå¤šçº¿ç¨‹åŠ é€Ÿï¼‰...\033[0m"
          echo -e "\033[33mğŸ“ ç¼–è¯‘æ—¥å¿—å°†ä¿å­˜åˆ°ï¼š./op13_kernel/build/build.log\033[0m"
          # ç¼–è¯‘æ—¶è¾“å‡ºå…³é”®è¿›åº¦ï¼ˆé¿å… GitHub Actions é™é»˜è¶…æ—¶æ–­å¼€ï¼‰
          make O=./build -j$(nproc) 2>&1 | tee ./build/build.log | grep -E "CC|LD|AR|OBJCOPY" || true

          # æ ¡éªŒç¼–è¯‘äº§ç‰©æ˜¯å¦å­˜åœ¨ï¼ˆç¡®ä¿å†…æ ¸é•œåƒç”ŸæˆæˆåŠŸï¼‰
          if [ -f ./build/arch/arm64/boot/Image ]; then
            echo -e "\033[32mâœ… å†…æ ¸ç¼–è¯‘å®Œæˆï¼ŒLXCç‰ˆå†…æ ¸é•œåƒå·²ç”Ÿæˆ\033[0m"
          else
            echo -e "\033[31mâŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆé•œåƒæ–‡ä»¶ï¼\033[0m"
            # è¾“å‡ºæœ€å100è¡Œç¼–è¯‘æ—¥å¿—ï¼Œä¾¿äºå¿«é€Ÿæ’æŸ¥é”™è¯¯
            tail -100 ./build/build.log
            exit 1
          fi
        shell: bash
        timeout-minutes: 90  # å»¶é•¿ç¼–è¯‘è¶…æ—¶ï¼ˆSM8750 å†…æ ¸å¤æ‚ï¼Œ90åˆ†é’Ÿè¶³å¤Ÿï¼‰
        env:
          DEFCONFIG: ${{ env.DEFCONFIG }}

      ##########################################################################
      # æ­¥éª¤7ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©ï¼ˆå†…æ ¸é•œåƒ + æ¨¡å—æ‰“åŒ…ï¼Œä¾¿äºåˆ·å…¥ä½¿ç”¨ï¼‰
      ##########################################################################
      - name: æ•´ç†å¹¶å½’æ¡£äº§ç‰©
        run: |
          # åˆ›å»ºæœ€ç»ˆäº§ç‰©ç›®å½•ï¼ˆç»Ÿä¸€å­˜æ”¾ï¼Œä¾¿äºä¸‹è½½ï¼‰
          mkdir -p ./final_output
          echo -e "\033[32mğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©...\033[0m"

          # å¤åˆ¶å†…æ ¸é•œåƒï¼ˆé‡å‘½åï¼ŒåŒ…å«å·¥å…·é“¾å’Œåˆ†æ”¯ä¿¡æ¯ï¼Œä¾¿äºè¯†åˆ«ï¼‰
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'oneplus/sm8750_6.6' }}"
          cp ./op13_kernel/build/arch/arm64/boot/Image ./final_output/OnePlus13_LXC_Kernel_LLVMClang18_${KERNEL_BRANCH}.img

          # æ‰“åŒ…å†…æ ¸æ¨¡å—ï¼ˆLXCå®¹å™¨è¿è¡Œå¿…éœ€ä¾èµ–ï¼‰
          if find ./op13_kernel/build -name "*.ko" | grep -q .; then
            find ./op13_kernel/build -name "*.ko" | xargs tar -zcf ./final_output/kernel_modules_lxc.tar.gz
            echo -e "\033[32mâœ… å†…æ ¸æ¨¡å—æ‰“åŒ…å®Œæˆï¼ˆLXCå®¹å™¨ä¾èµ–ï¼‰\033[0m"
          else
            echo -e "\033[33mâš ï¸  æœªæ‰¾åˆ°å†…æ ¸æ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç¼–è¯‘é…ç½®é™åˆ¶\033[0m"
            # è¾“å‡ºæ¨¡å—æœç´¢ç»“æœï¼Œä¾¿äºæ’æŸ¥
            find ./op13_kernel/build -name "*.ko"
          fi

          # è¾“å‡ºäº§ç‰©æ¸…å•ï¼ˆç›´è§‚å±•ç¤ºæ„å»ºç»“æœï¼‰
          echo -e "\033[32mâœ… äº§ç‰©æ•´ç†å®Œæˆï¼Œæ¸…å•å¦‚ä¸‹ï¼š\033[0m"
          ls -lh ./final_output/
        shell: bash

      ##########################################################################
      # æ­¥éª¤8ï¼šä¸Šä¼ äº§ç‰©åˆ°GitHub Actionsï¼ˆä¿ç•™90å¤©ï¼Œå¯ç›´æ¥ä¸‹è½½ï¼‰
      ##########################################################################
      - name: å½’æ¡£äº§ç‰©ä¾›ä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: ä¸€åŠ 13-LXCå†…æ ¸-LLVMClang18-${{ github.event.inputs.kernel_branch || 'oneplus/sm8750_6.6' }}
          path: ./final_output/*
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©ï¼Œå¯æŒ‰éœ€è°ƒæ•´ï¼ˆ1-90å¤©ï¼‰
          if-no-files-found: error  # è‹¥äº§ç‰©ç¼ºå¤±ï¼Œæ„å»ºæ ‡è®°ä¸ºå¤±è´¥
          compression-level: 0  # å†…æ ¸é•œåƒä¸å‹ç¼©ï¼Œä¸‹è½½åå¯ç›´æ¥ç”¨äºæ‰“åŒ… boot.img
