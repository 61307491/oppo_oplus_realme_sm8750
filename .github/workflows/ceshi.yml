name: ä¸€åŠ 13å†…æ ¸å¼€å¯LXCæ”¯æŒ - è‡ªåŠ¨åŒ–æ„å»ºï¼ˆç¨³å®šç‰ˆï¼‰
on:
  # è§¦å‘æ¡ä»¶ï¼š1. æ¨é€ä»£ç åˆ° main åˆ†æ”¯ï¼›2. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒé€‰æ‹©å†…æ ¸åˆ†æ”¯ï¼‰
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'å†…æ ¸åˆ†æ”¯ï¼ˆé»˜è®¤ï¼šoneplus/sm8750_6.6.89ï¼‰'
        required: true
        default: 'oneplus/sm8750_6.6.89'
        type: string
      toolchain_mirror:
        description: 'å·¥å…·é“¾é•œåƒï¼ˆé»˜è®¤ï¼šghproxyï¼Œå¤‡é€‰ï¼šgiteeï¼‰'
        required: false
        default: 'ghproxy'
        type: choice
        options:
          - ghproxy
          - gitee

jobs:
  build_lxc_kernel:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04ï¼ˆå®‰å“å†…æ ¸ç¼–è¯‘æœ€ä¼˜é€‰æ‹©ï¼‰
    runs-on: ubuntu-22.04
    env:
      # å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹ï¼‰
      DEFCONFIG: vendor/sm8750-perf_defconfig
      CLANG_VERSION: 18.0.0
      KERNEL_REPO: https://github.com/OnePlusOSS/android_kernel_oneplus_sm8750.git
      LXC_PATCH_URL: https://raw.githubusercontent.com/yangxiaohua2009/lxc-android-kernel-patches/main/op13_sm8750_lxc.patch

    steps:
      ##########################################################################
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆæµ…å…‹éš†ï¼Œæé€Ÿï¼‰
      ##########################################################################
      - name: æ£€å‡ºåŸºç¡€ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      ##########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆé™é»˜å®‰è£…ï¼Œå‡å°‘å†—ä½™è¾“å‡ºï¼‰
      ##########################################################################
      - name: å®‰è£…Ubuntuç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y > /dev/null 2>&1
          sudo apt install -y \
            git bc bison flex libssl-dev libelf-dev lz4 zstd curl patch \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu > /dev/null 2>&1
          echo -e "\033[32mâœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ\033[0m"

      ##########################################################################
      # æ­¥éª¤3ï¼šä¸‹è½½Neutron-Clangå·¥å…·é“¾ï¼ˆé•œåƒ+é‡è¯•+æ ¡éªŒï¼Œ100%æˆåŠŸï¼‰
      ##########################################################################
      - name: ä¸‹è½½å¹¶è§£å‹Neutron-Clangå·¥å…·é“¾
        run: |
          # æ ¹æ®é€‰æ‹©çš„é•œåƒè®¾ç½®å·¥å…·é“¾åœ°å€
          if [ "${{ github.event.inputs.toolchain_mirror }}" = "gitee" ]; then
            CLANG_URL="https://gitee.com/mirrors/Neutron-Toolchains/releases/raw/v${CLANG_VERSION}/neutron-clang-${CLANG_VERSION}.tar.gz"
          else
            CLANG_URL="https://ghproxy.com/https://github.com/Neutron-Toolchains/llvm-project/releases/download/v${CLANG_VERSION}/neutron-clang-${CLANG_VERSION}.tar.gz"
          fi

          # åˆ›å»ºå·¥å…·é“¾ç›®å½•
          mkdir -p ./clang
          echo -e "\033[32mğŸ”½ å¼€å§‹ä¸‹è½½å·¥å…·é“¾ï¼ˆé•œåƒï¼š${{ github.event.inputs.toolchain_mirror }}ï¼‰...\033[0m"

          # ä¸‹è½½å·¥å…·é“¾ï¼ˆé‡è¯•5æ¬¡ï¼Œé—´éš”3ç§’ï¼Œè¶…æ—¶60ç§’ï¼Œå®¹é”™æ€§æ‹‰æ»¡ï¼‰
          curl -L --progress-bar \
            --retry 5 \
            --retry-delay 3 \
            --connect-timeout 60 \
            --max-time 300 \
            "${CLANG_URL}" -o ./clang.tar.gz

          # æ ¡éªŒå‹ç¼©åŒ…å®Œæ•´æ€§ï¼ˆé¿å…ä¸‹è½½æŸåæ–‡ä»¶ï¼‰
          echo -e "\033[32mğŸ” æ ¡éªŒå·¥å…·é“¾å‹ç¼©åŒ…å®Œæ•´æ€§...\033[0m"
          if ! gzip -t ./clang.tar.gz; then
            echo -e "\033[31mâŒ å·¥å…·é“¾å‹ç¼©åŒ…æŸåï¼Œå°è¯•å¤‡ç”¨é•œåƒ...\033[0m"
            # è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨é•œåƒé‡æ–°ä¸‹è½½
            CLANG_URL="https://gitee.com/mirrors/Neutron-Toolchains/releases/raw/v${CLANG_VERSION}/neutron-clang-${CLANG_VERSION}.tar.gz"
            curl -L --progress-bar "${CLANG_URL}" -o ./clang.tar.gz
            # äºŒæ¬¡æ ¡éªŒï¼Œå¤±è´¥åˆ™ç»ˆæ­¢æ„å»º
            gzip -t ./clang.tar.gz || { echo -e "\033[31mâŒ å¤‡ç”¨é•œåƒä¸‹è½½ä¹Ÿå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼\033[0m"; exit 1; }
          fi

          # è§£å‹å·¥å…·é“¾ï¼ˆæ˜¾ç¤ºè¿›åº¦ï¼‰
          echo -e "\033[32mğŸ“¦ å¼€å§‹è§£å‹å·¥å…·é“¾...\033[0m"
          tar -xzf ./clang.tar.gz -C ./clang --progress
          rm -f ./clang.tar.gz  # æ¸…ç†å‹ç¼©åŒ…ï¼ŒèŠ‚çœç©ºé—´

          # éªŒè¯å·¥å…·é“¾å¯ç”¨æ€§ï¼ˆç¡®ä¿ç‰ˆæœ¬æ­£ç¡®ï¼‰
          echo -e "\033[32mâœ… å·¥å…·é“¾ç‰ˆæœ¬éªŒè¯...\033[0m"
          if ./clang/bin/clang --version | grep -q "version ${CLANG_VERSION}"; then
            echo -e "\033[32mâœ… å·¥å…·é“¾ä¸‹è½½éªŒè¯æˆåŠŸï¼ˆç‰ˆæœ¬ï¼š${CLANG_VERSION}ï¼‰\033[0m"
          else
            echo -e "\033[31mâŒ å·¥å…·é“¾ç‰ˆæœ¬é”™è¯¯ï¼Œæ„å»ºç»ˆæ­¢ï¼\033[0m"
            exit 1
          fi
        shell: bash
        timeout-minutes: 10  # å·¥å…·é“¾ä¸‹è½½è¶…æ—¶é™åˆ¶ï¼ˆ10åˆ†é’Ÿï¼‰

      ##########################################################################
      # æ­¥éª¤4ï¼šæ‹‰å–ä¸€åŠ 13å®˜æ–¹å†…æ ¸æºç ï¼ˆæŒ‡å®šåˆ†æ”¯ï¼Œæµ…å…‹éš†ï¼‰
      ##########################################################################
      - name: æ‹‰å–ä¸€åŠ 13å†…æ ¸æºç 
        run: |
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'oneplus/sm8750_6.6.89' }}"
          echo -e "\033[32mğŸ“¥ æ‹‰å–å†…æ ¸æºç ï¼ˆåˆ†æ”¯ï¼š${KERNEL_BRANCH}ï¼‰...\033[0m"
          git clone -b "${KERNEL_BRANCH}" --depth 1 "${KERNEL_REPO}" ./op13_kernel
          cd ./op13_kernel
          echo -e "\033[32mâœ… å†…æ ¸æºç æ‹‰å–å®Œæˆï¼Œå½“å‰åˆ†æ”¯ï¼š$(git rev-parse --abbrev-ref HEAD)\033[0m"
        shell: bash
        timeout-minutes: 5

      ##########################################################################
      # æ­¥éª¤5ï¼šä¸‹è½½å¹¶åº”ç”¨LXCæ”¯æŒè¡¥ä¸ï¼ˆå…ˆæµ‹è¯•æ— å†²çªï¼Œå†åº”ç”¨ï¼‰
      ##########################################################################
      - name: åº”ç”¨LXCæ”¯æŒè¡¥ä¸
        run: |
          cd ./op13_kernel
          echo -e "\033[32mğŸ“¥ ä¸‹è½½LXCæ”¯æŒè¡¥ä¸...\033[0m"
          curl -L --progress-bar "${LXC_PATCH_URL}" -o lxc_support.patch

          echo -e "\033[32mğŸ” æµ‹è¯•è¡¥ä¸å…¼å®¹æ€§ï¼ˆæ— å†²çªå†åº”ç”¨ï¼‰...\033[0m"
          if patch -p1 --dry-run < lxc_support.patch > /dev/null 2>&1; then
            echo -e "\033[32mâœ… è¡¥ä¸æ— å†²çªï¼Œå¼€å§‹åº”ç”¨...\033[0m"
            patch -p1 < lxc_support.patch
            echo -e "\033[32mâœ… LXCè¡¥ä¸åº”ç”¨å®Œæˆ\033[0m"
          else
            echo -e "\033[31mâŒ è¡¥ä¸åº”ç”¨å†²çªï¼Œè¯·æ£€æŸ¥è¡¥ä¸ä¸å†…æ ¸åˆ†æ”¯å…¼å®¹æ€§ï¼\033[0m"
            exit 1
          fi
        shell: bash
        timeout-minutes: 2

      ##########################################################################
      # æ­¥éª¤6ï¼šé…ç½®ç¼–è¯‘ç¯å¢ƒå¹¶ç¼–è¯‘å†…æ ¸ï¼ˆå¼€å¯LXCæ”¯æŒï¼‰
      ##########################################################################
      - name: é…ç½®å¹¶ç¼–è¯‘å†…æ ¸
        run: |
          cd ./op13_kernel
          # é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=$(pwd)/../clang/bin/clang
          export LD=$(pwd)/../clang/bin/ld.lld
          export AR=$(pwd)/../clang/bin/llvm-ar
          export NM=$(pwd)/../clang/bin/llvm-nm
          export OBJCOPY=$(pwd)/../clang/bin/llvm-objcopy
          export OBJDUMP=$(pwd)/../clang/bin/llvm-objdump

          echo -e "\033[32mâš™ï¸  åŠ è½½å®˜æ–¹é…ç½®å¹¶åˆå¹¶LXCé…ç½®...\033[0m"
          make O=./build "${DEFCONFIG}"
          make O=./build olddefconfig  # è‡ªåŠ¨åˆå¹¶é…ç½®ï¼Œé¿å…å†²çª

          echo -e "\033[32mğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆCPUæ ¸å¿ƒæ•°ï¼š$(nproc)ï¼‰...\033[0m"
          echo -e "\033[33mğŸ“ ç¼–è¯‘æ—¥å¿—å°†ä¿å­˜åˆ°ï¼š./op13_kernel/build/build.log\033[0m"
          make O=./build -j$(nproc) 2>&1 | tee ./build/build.log

          # æ ¡éªŒç¼–è¯‘äº§ç‰©æ˜¯å¦å­˜åœ¨
          if [ -f ./build/arch/arm64/boot/Image ]; then
            echo -e "\033[32mâœ… å†…æ ¸ç¼–è¯‘å®Œæˆï¼Œé•œåƒæ–‡ä»¶å·²ç”Ÿæˆ\033[0m"
          else
            echo -e "\033[31mâŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆé•œåƒæ–‡ä»¶ï¼\033[0m"
            exit 1
          fi
        shell: bash
        timeout-minutes: 60  # å†…æ ¸ç¼–è¯‘è¶…æ—¶é™åˆ¶ï¼ˆ60åˆ†é’Ÿï¼Œé€‚é…SM8750ï¼‰
        env:
          DEFCONFIG: ${{ env.DEFCONFIG }}

      ##########################################################################
      # æ­¥éª¤7ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©ï¼ˆå†…æ ¸é•œåƒ + æ¨¡å—æ‰“åŒ…ï¼‰
      ##########################################################################
      - name: æ•´ç†å¹¶å½’æ¡£äº§ç‰©
        run: |
          # åˆ›å»ºæœ€ç»ˆäº§ç‰©ç›®å½•
          mkdir -p ./final_output
          echo -e "\033[32mğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©...\033[0m"

          # å¤åˆ¶å†…æ ¸é•œåƒï¼ˆé‡å‘½åï¼Œä¾¿äºè¯†åˆ«ï¼‰
          cp ./op13_kernel/build/arch/arm64/boot/Image ./final_output/OnePlus13_LXC_Kernel_${{ github.event.inputs.kernel_branch || '6.6.89' }}.img

          # æ‰“åŒ…å†…æ ¸æ¨¡å—ï¼ˆLXCå®¹å™¨è¿è¡Œä¾èµ–ï¼‰
          if find ./op13_kernel/build -name "*.ko" | grep -q .; then
            find ./op13_kernel/build -name "*.ko" | xargs tar -zcf ./final_output/kernel_modules_lxc.tar.gz
            echo -e "\033[32mâœ… å†…æ ¸æ¨¡å—æ‰“åŒ…å®Œæˆ\033[0m"
          else
            echo -e "\033[33mâš ï¸  æœªæ‰¾åˆ°å†…æ ¸æ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç¼–è¯‘é…ç½®é—®é¢˜\033[0m"
          fi

          # è¾“å‡ºäº§ç‰©æ¸…å•
          echo -e "\033[32mâœ… äº§ç‰©æ•´ç†å®Œæˆï¼Œæ¸…å•å¦‚ä¸‹ï¼š\033[0m"
          ls -lh ./final_output/
        shell: bash

      ##########################################################################
      # æ­¥éª¤8ï¼šä¸Šä¼ äº§ç‰©åˆ°GitHub Actionsï¼ˆä¿ç•™90å¤©ï¼Œå¯ç›´æ¥ä¸‹è½½ï¼‰
      ##########################################################################
      - name: å½’æ¡£äº§ç‰©ä¾›ä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: ä¸€åŠ 13-LXCå†…æ ¸-${{ github.event.inputs.kernel_branch || '6.6.89' }}
          path: ./final_output/*
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©ï¼Œå¯æŒ‰éœ€è°ƒæ•´ï¼ˆ1-90ï¼‰
          if-no-files-found: error  # è‹¥äº§ç‰©ç¼ºå¤±ï¼Œæ„å»ºæ ‡è®°ä¸ºå¤±è´¥
          compression-level: 0  # å†…æ ¸é•œåƒä¸å‹ç¼©ï¼Œä¸‹è½½åå¯ç›´æ¥ä½¿ç”¨
