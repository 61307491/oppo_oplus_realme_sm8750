name: 加速版构建 6.6.89 欧加真OKI内核

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-abogki428889875-4k'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支'
        required: true
        type: choice
        default: 'sukisu'
        options: [sukisu, ksunext, mksu, ksu]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ===== 前面步骤保持不变（初始化 / KernelSU / 各种 patch） =====
      # ……（此处省略，你的原始内容完全保留）……

      # ============================================================
      # ⭐⭐⭐ 新增：整合 LXC 到 build.config.gki（核心步骤） ⭐⭐⭐
      # ============================================================
      - name: 整合 LXC 配置到 build.config.gki
        run: |
          cd kernel_workspace
          cat > ./common/build.config.gki <<'EOF'
          # build.config.gki
          # LXC safe enable for GKI / OnePlus
          DEFCONFIG=gki_defconfig

          POST_DEFCONFIG_CMDS="update_config"

          function update_config() {
            CONFIG_TOOL="${KERNEL_DIR}/scripts/config"
            CONFIG_FILE="${OUT_DIR}/.config"

            # ===== Namespace（LXC 核心）=====
            ${CONFIG_TOOL} --file ${CONFIG_FILE} \
              -e CONFIG_NAMESPACES \
              -e CONFIG_UTS_NS \
              -e CONFIG_IPC_NS \
              -e CONFIG_PID_NS \
              -e CONFIG_USER_NS \
              -e CONFIG_NET_NS

            # ===== IPC / SYSV =====
            ${CONFIG_TOOL} --file ${CONFIG_FILE} \
              -e CONFIG_SYSVIPC \
              -e CONFIG_SYSVIPC_SYSCTL \
              -e CONFIG_POSIX_MQUEUE

            # ===== Cgroup（LXC / systemd）=====
            ${CONFIG_TOOL} --file ${CONFIG_FILE} \
              -e CONFIG_CGROUPS \
              -e CONFIG_CGROUP_CPU \
              -e CONFIG_CGROUP_CPUACCT \
              -e CONFIG_CGROUP_SCHED \
              -e CONFIG_CGROUP_PIDS \
              -e CONFIG_CGROUP_DEVICE \
              -e CONFIG_MEMCG

            # ===== 文件系统 =====
            ${CONFIG_TOOL} --file ${CONFIG_FILE} \
              -e CONFIG_OVERLAY_FS \
              -e CONFIG_TMPFS \
              -e CONFIG_TMPFS_POSIX_ACL \
              -e CONFIG_TMPFS_XATTR

            # ===== 网络 =====
            ${CONFIG_TOOL} --file ${CONFIG_FILE} \
              -e CONFIG_VETH \
              -e CONFIG_BRIDGE \
              -e CONFIG_BRIDGE_NETFILTER

            # ===== 应用配置 =====
            (cd ${OUT_DIR} && make O=${OUT_DIR} olddefconfig)
          }
          EOF

      # ===== 后续步骤继续原样执行 =====
      - name: 添加 KSU & 其他配置项
        run: |
          cd kernel_workspace
          echo "CONFIG_KSU=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: 启用网络功能增强优化配置
        if: inputs.better_net
        run: |
          cd kernel_workspace
          echo "CONFIG_IP_SET=y" >> ./common/arch/arm64/configs/gki_defconfig

      - name: 构建内核
        run: |
          cd kernel_workspace/common
          make O=out gki_defconfig
          make -j$(nproc) O=out Image

      # ===== 打包 / 上传 / release 步骤保持不变 =====