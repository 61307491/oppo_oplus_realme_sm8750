name: OnePlus13 Kernel (LXC Enabled) Auto-Build
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装基础依赖
        run: |
          sudo apt update -y
          sudo apt install -y git bc bison flex libssl-dev libelf-dev lz4 zstd curl patch

      - name: 下载工具链、源码和LXC补丁
        run: |
          # 下载工具链
          curl -L https://github.com/Neutron-Toolchains/llvm-project/releases/latest/download/neutron-clang.tar.gz | tar -xzf - -C ./clang
          # 拉取一加13内核源码
          git clone -b oneplus/sm8750_6.6.89 https://github.com/OnePlusOSS/android_kernel_oneplus_sm8750.git op13_kernel
          cd op13_kernel
          # 下载LXC支持补丁
          curl -L https://raw.githubusercontent.com/your-repo/patches/main/op13_lxc_support.patch -o lxc_support.patch
          # 应用补丁
          patch -p1 < lxc_support.patch

      - name: 配置LXC核心参数并编译
        run: |
          cd op13_kernel
          export ARCH=arm64
          export CC=$(pwd)/../clang/bin/clang
          export LD=$(pwd)/../clang/bin/ld.lld
          # 加载默认配置
          make O=build vendor/sm8750-perf_defconfig
          # 启用LXC配置
          cat >> build/.config << EOF
          CONFIG_NAMESPACES=y
          CONFIG_UTS_NS=y
          CONFIG_IPC_NS=y
          CONFIG_USER_NS=y
          CONFIG_PID_NS=y
          CONFIG_NET_NS=y
          CONFIG_CGROUP_CPUACCT=y
          CONFIG_CGROUP_DEVICE=y
          CONFIG_CGROUP_FREEZER=y
          CONFIG_CGROUP_SCHED=y
          CONFIG_CPUSETS=y
          CONFIG_MEMCG=y
          CONFIG_KEYS=y
          CONFIG_VETH=y
          CONFIG_BRIDGE=y
          CONFIG_BRIDGE_NETFILTER=y
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y
          CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y
          CONFIG_OVERLAY_FS=y
          CONFIG_SECCOMP=y
          CONFIG_SECCOMP_FILTER=y
          CONFIG_ANDROID_PARANOID_NETWORK=0
          EOF
          # 合并配置
          make O=build olddefconfig
          # 开始编译
          make O=build -j$(nproc)

      - name: 归档LXC版内核产物
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus13-Kernel-LXC-6.6.89
          path: |
            op13_kernel/build/arch/arm64/boot/Image
            op13_kernel/build/modules.tar.gz
          retention-days: 90
