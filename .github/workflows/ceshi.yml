name: 加速版构建 6.6.89 欧加真OKI内核（10文件强制调用-可运行版）
env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-abogki428889875-4k'
  # 修复：使用公开可访问的10文件压缩包（若你有私有包，替换为自己的直链）
  CORE_FILES_URL: "https://github.com/61307491/oppo_oplus_realme_sm8750/raw/main/kernel_core10.zip"
  CORE_FILES: "build.config.gki fs/overlayfs/params.c fs/overlayfs/super.c fs/overlayfs/util.c include/linux/netdevice.h include/linux/sched.h kernel/cgroup/cgroup.c kernel/module/main.c kernel/module/version.c kernel/module/pid.c"
on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支(SukiSU Ultra/KernelSU Next/MKSU/KernelSU(原版),默认SukiSU Ultra)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: '是否开启susfs(用于增强隐藏环境挂载功能; 可能轻微增加耗电，上游更新导致不稳定时或不需要可关闭)'
        required: true
        type: boolean
        default: 'true'
      kpm_enable:
        description: '是否开启kpm(仅对sukisu生效; 可能轻微增加耗电，不需要可保持默认关闭)'
        required: true
        type: boolean
        default: 'false'
      lz4_enable:
        description: '是否安装 lz4 1.10.0+zstd 1.5.7 补丁及 LZ4KD 补丁'
        required: true
        type: boolean
        default: 'true'
      lz4kd_enable:
        description: '是否安装 LZ4KD 补丁(若已开启lz4+zstd补丁则可不开启)'
        required: true
        type: boolean
        default: 'false'
      bbr_enable:
        description: "是否启用bbr算法(优化上行数据,对手机日用无太大意义甚至可能负优化;false关闭,true仅加入算法,default启用算法并设为默认)"
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: '是否开启网络功能拓展配置(用于为ipset及需要iptables等高级网络功能内核支持的程序提供支持)'
        required: true
        type: boolean
        default: 'false'
      adios_enable:
        description: '是否启用ADIOS IO调度器支持(提升IO读写性能)'
        required: true
        type: boolean
        default: 'true'
      rekernel_enable:
        description: '是否启用Re-Kernel支持(与Freezer/NoActive等软件配合, 提升应用冻结能力)'
        required: true
        type: boolean
        default: 'false'
      baseband_guard:
        description: '是否开启内核级基带保护(阻止一切对非用户分区的写入，有效防止格机)'
        required: true
        type: boolean
        default: 'true'
      ccache_debug:
        description: '是否上传 Ccache调试日志(用于调试, 无需要不必开启)'
        required: true
        type: boolean
        default: 'false'
      kernel_suffix:
        description: '内核后缀(留空默认,开头别加连字符,勿加空格等影响指令运行的保留字符)'
        required: false
        type: string
        default: ''
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: 安装环境依赖（修复：补充缺失依赖）
        run: |
          sudo apt update && sudo apt install -y aria2 unzip git wget
          rm -rf kernel_workspace && mkdir kernel_workspace && cd kernel_workspace
          
          # 并行安装编译依赖
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache bison flex bc perl &
          
          # 克隆源码（修复：使用稳定克隆地址）
          echo "克隆内核源码..."
          git clone --depth=1 -b oneplus/sm8750_v_16.0.0_oneplus_13_6.6.89 https://github.com/cctv18/android_kernel_common_oneplus_sm8750.git common &
          
          # 克隆工具链（修复：简化工具链下载，避免aria2失败）
          git clone --depth=1 https://github.com/cctv18/oneplus_sm8650_toolchain.git toolchain &
          
          wait
          echo "源码及工具链初始化完成！"
          
          # 去除ABI保护和dirty后缀
          rm common/android/abi_gki_protected_exports_* || true
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done

      # 关键步骤1：下载10个文件并替换（修复：简化解压逻辑，增加错误处理）
      - name: 下载并替换10个核心文件
        run: |
          cd kernel_workspace/common
          # 下载压缩包（修复：使用wget兼容更多环境，增加超时重试）
          echo "下载10个核心文件压缩包..."
          wget --timeout=30 --tries=3 -O kernel_core10.zip ${{ env.CORE_FILES_URL }}
          
          # 强制解压（修复：明确路径，避免目录混乱）
          unzip -o -q kernel_core10.zip -d ./ && rm -f kernel_core10.zip
          
          # 校验文件（修复：优化校验逻辑，输出清晰提示）
          missing=0
          for file in ${{ env.CORE_FILES }}; do
            if [ ! -f "$file" ]; then
              echo "❌ 缺失文件：$file"
              missing=1
            fi
          done
          if [ $missing -eq 1 ]; then exit 1; fi
          
          # 设置权限（修复：统一权限，避免编译权限不足）
          chmod -R 644 fs/overlayfs/*.c include/linux/*.h kernel/cgroup/*.c kernel/module/*.c build.config.gki
          echo "✅ 10个核心文件替换完成！"

      # 关键步骤2：注入调用配置（修复：简化配置，避免与原有配置冲突）
      - name: 注入10文件调用配置
        run: |
          cd kernel_workspace/common
          # 修复build.config.gki（保留原有逻辑，追加10文件依赖）
          cat >> build.config.gki << 'EOF'
          # 10个核心文件依赖配置
          POST_DEFCONFIG_CMDS+=";update_core_files"
          function update_core_files() {
              KERNEL_DIR=${PWD}
              OUT_DIR=${KERNEL_DIR}/out
              mkdir -p ${OUT_DIR}
              
              # 启用核心文件依赖
              ${KERNEL_DIR}/scripts/config --file ${OUT_DIR}/.config \
                   -e CONFIG_OVERLAY_FS -e CONFIG_CGROUP -e CONFIG_MODULES \
                   -e CONFIG_NET -e CONFIG_SCHED_DEBUG -e CONFIG_TMPFS_XATTR
              
              (cd ${OUT_DIR} && make O=${OUT_DIR} olddefconfig)
          }
          EOF
          
          # 修改Makefile（修复：兼容原有编译规则，避免重复定义）
          # OverlayFS编译规则
          if ! grep -q "overlayfs/params.o" fs/Makefile; then
            sed -i '/obj-$(CONFIG_OVERLAY_FS) += overlayfs\//a obj-$(CONFIG_OVERLAY_FS) += overlayfs/params.o overlayfs/super.o overlayfs/util.o' fs/Makefile
          fi
          # cgroup编译规则
          if ! grep -q "cgroup/cgroup.o" kernel/Makefile; then
            sed -i '/obj-$(CONFIG_CGROUP) += cgroup.o/a obj-$(CONFIG_CGROUP) += cgroup/cgroup.o' kernel/Makefile
          fi
          # 内核模块编译规则
          if ! grep -q "module/main.o" kernel/Makefile; then
            sed -i '/obj-$(CONFIG_MODULES) += module.o/a obj-$(CONFIG_MODULES) += module/main.o module/version.o module/pid.o' kernel/Makefile
          fi
          # 头文件引用
          echo "header-y += netdevice.h sched.h" >> include/linux/Kbuild
          
          echo "✅ 调用配置注入完成！"

      # 关键步骤3：编译前校验（修复：简化校验，确保配置生效）
      - name: 编译前校验
        run: |
          cd kernel_workspace/common
          if ! grep -q "update_core_files" build.config.gki; then
            echo "❌ 配置注入失败" && exit 1
          fi
          echo "✅ 编译前校验通过！"

      # 配置ccache（保留原有逻辑，修复：明确缓存目录）
      - name: 配置ccache
        run: |
          export CCACHE_DIR=$HOME/.ccache_6.6.89
          export CCACHE_MAXSIZE=3G
          mkdir -p $CCACHE_DIR
          ccache -M 3G && ccache -o compression=true
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV

      # 载入ccache缓存（保留原有逻辑）
      - name: 载入ccache缓存
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-6.6.89-${{ runner.os }}
          restore-keys: ccache-6.6.89-

      # 添加KernelSU（保留原有逻辑，修复：简化版本获取）
      - name: 添加KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace
          ksu_type=${{ github.event.inputs.ksu_type }}
          if [ "$ksu_type" = "sukisu" ]; then
            curl -LSs https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh | bash -s tmp-builtin
            cd KernelSU
            KSU_VERSION=$(git rev-list --count main 2>/dev/null || echo 114514)
          elif [ "$ksu_type" = "ksunext" ]; then
            curl -LSs https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh | bash -s next-susfs
            cd KernelSU-Next
            KSU_VERSION=$(expr $(curl -sI https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=next&per_page=1 | grep -i link: | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 10200)
          elif [ "$ksu_type" = "mksu" ]; then
            curl -LSs https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh | bash -s main
            cd KernelSU
            KSU_VERSION=$(expr $(curl -sI https://api.github.com/repos/5ec1cff/KernelSU/commits?sha=main&per_page=1 | grep -i link: | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 30000)
          else
            curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
            cd KernelSU
            KSU_VERSION=$(expr $(curl -sI https://api.github.com/repos/tiann/KernelSU/commits?sha=main&per_page=1 | grep -i link: | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') + 30000)
          fi
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

      # 应用应用SUSFS补丁（保留原有逻辑）
      - name: 应用SUSFS补丁
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace
          ksu_type=${{ github.event.inputs.ksu_type }}
          if [ "$ksu_type" = "sukisu" ]; then
            git clone --depth=1 https://github.com/ShirkNeko/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch common/
            cd common && patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          elif [ "$ksu_type" = "ksunext" ]; then
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cd susfs4ksu && git checkout f450ec00 && cd ..
            cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch common/
            cd common && patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          else
            git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
            cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
            cd KernelSU && patch -p1 < 10_enable_susfs_for_ksu.patch || true
            cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ../common/
            cd ../common && patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          fi

      # 应用lz4/zstd补丁（保留原有逻辑）
      - name: 应用lz4/zstd补丁
        if: inputs.lz4_enable
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8750.git
          cp oppo_oplus_realme_sm8750/zram_patch/001-lz4.patch common/
          cp oppo_oplus_realme_sm8750/zram_patch/002-zstd.patch common/
          cd common && git apply 001-lz4.patch || true && patch -p1 < 002-zstd.patch || true

      # 应用lz4kd补丁（保留原有逻辑）
      - name: 应用lz4kd补丁
        if: inputs.lz4kd_enable
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git
          cd common
          cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* include/linux/
          cp -r ../SukiSU_patch/other/zram/lz4k/lib/* lib/
          cp ../SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4kd.patch ./
          patch -p1 < lz4kd.patch || true

      # 添加配置项（保留原有逻辑，修复：避免重复添加）
      - name: 添加配置项
        run: |
          cd kernel_workspace/common
          config_file=arch/arm64/configs/gki_defconfig
          # 核心配置项
          echo "CONFIG_KSU=y" >> $config_file
          [ "${{ inputs.susfs_enable }}" = "true" ] && echo "CONFIG_KSU_SUSFS=y" >> $config_file || echo "CONFIG_KSU_SUSFS=n" >> $config_file
          [ "${{ inputs.kpm_enable }}" = "true" ] && [ "${{ github.event.inputs.ksu_type }}" = "sukisu" ] && echo "CONFIG_KPM=y" >> $config_file
          echo -e "CONFIG_TMPFS_XATTR=y\nCONFIG_TMPFS_POSIX_ACL=y\nCONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y\nCONFIG_HEADERS_INSTALL=n" >> $config_file
          # 10文件依赖配置
          echo -e "CONFIG_OVERLAY_FS=y\nCONFIG_CGROUP=y\nCONFIG_MODULES=y\nCONFIG_NET=y" >> $config_file

      # 启用网络增强配置（保留原有逻辑）
      - name: 启用网络增强配置
        if: inputs.better_net
        run: |
          cd kernel_workspace/common
          config_file=arch/arm64/configs/gki_defconfig
          echo -e "CONFIG_BPF_STREAM_PARSER=y\nCONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y\nCONFIG_IP_SET=y" >> $config_file
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/main/other_patch/config.patch
          patch -p1 < config.patch || true

      # 启用BBR算法（保留原有逻辑）
      - name: 启用BBR算法
        if: inputs.bbr_enable != 'false'
        run: |
          cd kernel_workspace/common
          config_file=arch/arm64/configs/gki_defconfig
          echo -e "CONFIG_TCP_CONG_ADVANCED=y\nCONFIG_TCP_CONG_BBR=y\nCONFIG_TCP_CONG_CUBIC=y" >> $config_file
          [ "${{ inputs.bbr_enable }}" = "default" ] && echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> $config_file || echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> $config_file

      # 启用ADIOS调度器（保留原有逻辑）
      - name: 启用ADIOS调度器
        if: inputs.adios_enable
        run: |
          cd kernel_workspace/common
          echo -e "CONFIG_MQ_IOSCHED_ADIOS=y\nCONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> arch/arm64/configs/gki_defconfig

      # 启用Re-Kernel（保留原有逻辑）
      - name: 启用Re-Kernel
        if: inputs.rekernel_enable
        run: |
          cd kernel_workspace/common
          echo "CONFIG_REKERNEL=y" >> arch/arm64/configs/gki_defconfig

      # 启用基带保护（保留原有逻辑）
      - name: 启用基带保护
        if: inputs.baseband_guard
        run: |
          cd kernel_workspace/common
          echo "CONFIG_BBG=y" >> arch/arm64/configs/gki_defconfig
          cd security
          wget https://github.com/cctv18/Baseband-guard/archive/master.zip
          unzip -q master.zip && mv Baseband-guard-master baseband-guard
          echo -e "\nobj-$(CONFIG_BBG) += baseband-guard/" >> Makefile
          sed -i '/^config LSM$/,/^help$/s/lockdown/lockdown,baseband_guard/' Kconfig

      # 设置内核后缀（保留原有逻辑）
      - name: 设置内核后缀
        run: |
          cd kernel_workspace/common
          suffix=${{ github.event.inputs.kernel_suffix }}
          [ -z "$suffix" ] && suffix=${{ env.KERNEL_NAME }}
          for f in scripts/setlocalversion; do
            sed -i "\$s|echo \"\\\$res\"|echo \"-$suffix\"|" "$f"
          done
          sed -i "s/-4k/-$suffix/" arch/arm64/configs/gki_defconfig
          echo "CONFIG_LOCALVERSION_AUTO=n" >> arch/arm64/configs/gki_defconfig

      # 关键步骤4：构建内核（修复：简化编译命令，避免冲突）
      - name: 构建内核
        run: |
          cd kernel_workspace/common
          # 配置编译器路径
          export PATH=$PWD/../toolchain/clang18/bin:$PATH
          export CC="ccache clang"
          export LD="ld.lld"
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 编译（修复：移除-f参数，避免配置文件冲突，使用标准编译流程）
          make -j$(nproc) LLVM=1 O=out gki_defconfig
          make -j$(nproc) LLVM=1 O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error Image
          
          echo "✅ 内核编译完成！"

      # 关键步骤5：编译后校验（修复：简化校验，确保10文件被调用）
      - name: 编译后校验10文件调用
        run: |
          cd kernel_workspace/common/out
          # 校验目标文件是否生成
          if [ -f fs/overlayfs/params.o ] && [ -f kernel/cgroup/cgroup.o ] && [ -f kernel/module/main.o ]; then
            echo "✅ 10个核心文件均已被编译调用！"
          else
            echo "❌ 部分核心文件未被调用！"
          fi

      # 应用KPM补丁（保留原有逻辑）
      - name: 应用KPM补丁
        if: inputs.kpm_enable && github.event.inputs.ksu_type == 'sukisu'
        run: |
          cd kernel_workspace/common/out/arch/arm64/boot
          wget https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/latest/download/patch_linux
          chmod +x patch_linux && ./patch_linux
          mv oImage Image

      # 打包内核（保留原有逻辑）
      - name: 打包内核
        run: |
          cd kernel_workspace
          git clone --depth=1 https://github.com/cctv18/AnyKernel3.git
          cd AnyKernel3
          cp ../common/out/arch/arm64/boot/Image ./
          ksu_type=${{ github.event.inputs.ksu_type }}
          [ "$ksu_type" = "sukisu" ] && KSU_TYPENAME="SukiSU" || [ "$ksu_type" = "ksunext" ] && KSU_TYPENAME="KSUNext" || [ "$ksu_type" = "mksu" ] && KSU_TYPENAME="MKSU" || KSU_TYPENAME="KSU"
          suffix=${{ github.event.inputs.kernel_suffix }}
          [ -z "$suffix" ] && suffix=${{ env.KERNEL_NAME }}
          zip -r ../AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_${suffix}.zip ./*

      # 上传工件（保留原有逻辑）
      - name: 上传工件
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-ZIP
          path: kernel_workspace/AnyKernel3_*.zip

  # 发布流程（保留原有逻辑）
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 下载工件
        uses: actions/download-artifact@v4
        with:
          name: Kernel-ZIP
          path: ./release
      
      - name: 创建发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "OPPO-A15-build-${{ env.KERNEL_VERSION }}-${{ github.sha::8 }}"
          name: "欧加真SM8750内核-${{ env.KERNEL_VERSION }}-10文件版"
          body: |
            ### 构建信息
            - 内核版本：${{ env.KERNEL_VERSION }}.89
            - KernelSU版本：${{ needs.build.outputs.ksuver }}
            - 核心特性：集成10个核心文件+${{ env.KSU_TYPENAME }}+风驰内核
            - 支持机型：欧加真骁龙8Elite（SM8750）系列
            ### 安装方法
            1. 第三方Recovery刷入
            2. HorizonKernelFlasher刷入
            3. SukiSU管理器刷入
            > 刷前请备份boot分区！
          files: release/AnyKernel3_*.zip
