name: ä¸€åŠ 13å†…æ ¸å¼€å¯LXCæ”¯æŒ - è‡ªåŠ¨åŒ–æ„å»º
on:
  # è§¦å‘æ¡ä»¶ï¼š1. æ¨é€ä»£ç åˆ° main åˆ†æ”¯ï¼›2. æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
  workflow_dispatch:
    # æ‰‹åŠ¨è§¦å‘æ—¶å¯é€‰æ‹©å†…æ ¸åˆ†æ”¯ï¼ˆé»˜è®¤6.6.89ç¨³å®šç‰ˆï¼‰
    inputs:
      kernel_branch:
        description: 'å†…æ ¸åˆ†æ”¯'
        required: true
        default: 'oneplus/sm8750_6.6.89'
        type: string

jobs:
  build_lxc_kernel:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04ï¼ˆé€‚é…å®‰å“å†…æ ¸ç¼–è¯‘ï¼Œç¨³å®šæ€§æœ€ä½³ï¼‰
    runs-on: ubuntu-22.04
    steps:
      ##########################################################################
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆè‹¥éœ€è‡ªå®šä¹‰è¡¥ä¸ï¼Œå¯å°†è¡¥ä¸æ”¾åœ¨ä»“åº“patchesç›®å½•ï¼‰
      ##########################################################################
      - name: æ£€å‡ºåŸºç¡€ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # æµ…å…‹éš†ï¼Œæé€Ÿ

      ##########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆå·¥å…·é“¾ã€å†…æ ¸ç¼–è¯‘å·¥å…·ï¼‰
      ##########################################################################
      - name: å®‰è£…Ubuntuç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y \
            git bc bison flex libssl-dev libelf-dev lz4 zstd curl patch \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu  # å¤‡ç”¨äº¤å‰ç¼–è¯‘å™¨
          echo "âœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      ##########################################################################
      # æ­¥éª¤3ï¼šä¸‹è½½Neutron-Clangå·¥å…·é“¾ï¼ˆé€‚é…SM8750 6.6.xå†…æ ¸ï¼‰
      ##########################################################################
      - name: ä¸‹è½½å¹¶è§£å‹Neutron-Clangå·¥å…·é“¾
        run: |
          CLANG_VERSION="18.0.0"
          CLANG_URL="https://github.com/Neutron-Toolchains/llvm-project/releases/download/v${CLANG_VERSION}/neutron-clang-${CLANG_VERSION}.tar.gz"
          # åˆ›å»ºå·¥å…·é“¾ç›®å½•å¹¶ä¸‹è½½è§£å‹
          mkdir -p ./clang
          curl -L --progress-bar "${CLANG_URL}" | tar -xzf - -C ./clang
          # éªŒè¯å·¥å…·é“¾å¯ç”¨æ€§
          ./clang/bin/clang --version | grep "18.0.0" && echo "âœ… å·¥å…·é“¾ä¸‹è½½éªŒè¯æˆåŠŸ"
        shell: bash

      ##########################################################################
      # æ­¥éª¤4ï¼šæ‹‰å–ä¸€åŠ 13å®˜æ–¹å†…æ ¸æºç 
      ##########################################################################
      - name: æ‹‰å–ä¸€åŠ 13å†…æ ¸æºç 
        run: |
          KERNEL_REPO="https://github.com/OnePlusOSS/android_kernel_oneplus_sm8750.git"
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'oneplus/sm8750_6.6.89' }}"
          # å…‹éš†æºç ï¼ˆæµ…å…‹éš†ï¼Œä»…æ‹‰å–æŒ‡å®šåˆ†æ”¯ï¼‰
          git clone -b "${KERNEL_BRANCH}" --depth 1 "${KERNEL_REPO}" ./op13_kernel
          cd ./op13_kernel
          echo "âœ… å†…æ ¸æºç æ‹‰å–å®Œæˆï¼ˆåˆ†æ”¯ï¼š${KERNEL_BRANCH}ï¼‰"
        shell: bash

      ##########################################################################
      # æ­¥éª¤5ï¼šä¸‹è½½å¹¶åº”ç”¨LXCæ”¯æŒè¡¥ä¸ï¼ˆå·²é€‚é…ä¸€åŠ 13 defconfigï¼‰
      ##########################################################################
      - name: åº”ç”¨LXCæ”¯æŒè¡¥ä¸
        run: |
          cd ./op13_kernel
          # ä¸‹è½½é€‚é…ä¸€åŠ 13çš„LXCè¡¥ä¸
          LXC_PATCH_URL="https://raw.githubusercontent.com/yangxiaohua2009/lxc-android-kernel-patches/main/op13_sm8750_lxc.patch"
          curl -L "${LXC_PATCH_URL}" -o lxc_support.patch
          # å…ˆæµ‹è¯•è¡¥ä¸æ— å†²çªï¼Œå†å®é™…åº”ç”¨
          echo "ğŸ” æµ‹è¯•è¡¥ä¸å…¼å®¹æ€§..."
          patch -p1 --dry-run < lxc_support.patch || exit 1
          echo "âœ… è¡¥ä¸æ— å†²çªï¼Œå¼€å§‹åº”ç”¨..."
          patch -p1 < lxc_support.patch
          echo "âœ… LXCè¡¥ä¸åº”ç”¨å®Œæˆ"
        shell: bash

      ##########################################################################
      # æ­¥éª¤6ï¼šé…ç½®ç¼–è¯‘ç¯å¢ƒå¹¶ç¼–è¯‘å†…æ ¸
      ##########################################################################
      - name: é…ç½®å¹¶ç¼–è¯‘å†…æ ¸ï¼ˆå¼€å¯LXCæ”¯æŒï¼‰
        run: |
          cd ./op13_kernel
          # é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=$(pwd)/../clang/bin/clang
          export LD=$(pwd)/../clang/bin/ld.lld
          export AR=$(pwd)/../clang/bin/llvm-ar
          export NM=$(pwd)/../clang/bin/llvm-nm
          export OBJCOPY=$(pwd)/../clang/bin/llvm-objcopy
          # åŠ è½½å®˜æ–¹é…ç½® + åˆå¹¶LXCé…ç½®
          make O=./build ${{ env.DEFCONFIG }}
          make O=./build olddefconfig  # è‡ªåŠ¨åˆå¹¶é…ç½®ï¼Œé¿å…å†²çª
          # å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨å…¨éƒ¨CPUæ ¸å¿ƒæé€Ÿï¼‰
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼Œæ—¥å¿—è¾“å‡ºåˆ° build/build.log"
          make O=./build -j$(nproc) 2>&1 | tee ./build/build.log
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"
        env:
          DEFCONFIG: vendor/sm8750-perf_defconfig  # ä¸€åŠ 13å®˜æ–¹æ€§èƒ½ç‰ˆé…ç½®
        shell: bash

      ##########################################################################
      # æ­¥éª¤7ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©å¹¶å½’æ¡£ï¼ˆä¾¿äºä¸‹è½½ä½¿ç”¨ï¼‰
      ##########################################################################
      - name: æ•´ç†å¹¶å½’æ¡£äº§ç‰©
        run: |
          # åˆ›å»ºäº§ç‰©ç›®å½•ï¼Œå¤åˆ¶å†…æ ¸é•œåƒå’Œæ¨¡å—
          mkdir -p ./final_output
          cp ./op13_kernel/build/arch/arm64/boot/Image ./final_output/OnePlus13_LXC_Kernel.img
          # æ‰“åŒ…å†…æ ¸æ¨¡å—ï¼ˆLXCå®¹å™¨ä¾èµ–ï¼‰
          find ./op13_kernel/build -name "*.ko" | xargs tar -zcf ./final_output/kernel_modules_lxc.tar.gz
          echo "âœ… äº§ç‰©æ•´ç†å®Œæˆï¼ŒåŒ…å«ï¼š"
          echo "   - å†…æ ¸é•œåƒï¼šOnePlus13_LXC_Kernel.img"
          echo "   - å†…æ ¸æ¨¡å—ï¼škernel_modules_lxc.tar.gz"
        shell: bash

      ##########################################################################
      # æ­¥éª¤8ï¼šä¸Šä¼ äº§ç‰©åˆ°GitHub Actionsï¼ˆä¿ç•™90å¤©ï¼Œå¯ç›´æ¥ä¸‹è½½ï¼‰
      ##########################################################################
      - name: å½’æ¡£äº§ç‰©ä¾›ä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: ä¸€åŠ 13-LXCå†…æ ¸-${{ github.event.inputs.kernel_branch || '6.6.89' }}
          path: ./final_output/*
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©ï¼Œå¯æŒ‰éœ€è°ƒæ•´
          if-no-files-found: error  # è‹¥äº§ç‰©ç¼ºå¤±ï¼Œæ„å»ºå¤±è´¥
