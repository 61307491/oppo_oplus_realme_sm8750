name: Build Kernel

on:
  workflow_dispatch:
    inputs:
      lz4_enable:
        description: 'Enable lz4/zstd patch'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 初始化环境
        run: |
          sudo apt update
          sudo apt install -y git wget curl patch bc bison flex build-essential             libssl-dev libelf-dev dwarves ccache python3

      - name: 拉取内核源码
        run: |
          mkdir -p kernel_workspace
          cd kernel_workspace
          git clone https://github.com/whitewhale0612/android_kernel_common_oneplus_sm8750.git common

      - name: 应用 lz4 1.10.0 & zstd 1.5.7 补丁
        if: inputs.lz4_enable
        run: |
          cd kernel_workspace
          git clone https://github.com/61307491/oppo_oplus_realme_sm8750.git
          cp ./oppo_oplus_realme_sm8750/zram_patch/001-lz4.patch ./common/
          cp ./oppo_oplus_realme_sm8750/zram_patch/lz4armv8.S ./common/lib
          cp ./oppo_oplus_realme_sm8750/zram_patch/002-zstd.patch ./common/
          cd ./common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true

      - name: 应用 6.6 LXC 补丁（增量）
        run: |
          cd kernel_workspace
          mkdir -p ./common/patches
          wget -O ./common/patches/6.6lxc.patch             https://raw.githubusercontent.com/61307491/oppo_oplus_realme_sm8750/main/6.6lxc.patch             || curl -fsSL -o ./common/patches/6.6lxc.patch             https://raw.githubusercontent.com/61307491/oppo_oplus_realme_sm8750/main/6.6lxc.patch
          cd ./common
          if git apply --index ./patches/6.6lxc.patch; then
            echo "LXC patch applied with git apply"
          else
            patch -p1 < ./patches/6.6lxc.patch
          fi

      - name: Kernel 编译（示例）
        run: |
          cd kernel_workspace/common
          export ARCH=arm64
          make defconfig
          make -j$(nproc)
