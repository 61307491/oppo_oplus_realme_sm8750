name: ä¸€åŠ 13å†…æ ¸å¼€å¯LXCæ”¯æŒ - è°·æ­Œå·¥å…·é“¾ç¼–è¯‘ç‰ˆ
on:
  # è§¦å‘æ¡ä»¶ï¼š1. æ¨é€ä»£ç åˆ° main åˆ†æ”¯ï¼›2. æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒé€‰æ‹©å†…æ ¸åˆ†æ”¯ï¼‰
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'å†…æ ¸åˆ†æ”¯ï¼ˆé»˜è®¤ï¼šoneplus/sm8750_6.6.89ï¼‰'
        required: true
        default: 'oneplus/sm8750_6.6.89'
        type: string

jobs:
  build_lxc_kernel:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04ï¼ˆå®‰å“å®˜æ–¹æ¨èç¼–è¯‘ç¯å¢ƒï¼‰
    runs-on: ubuntu-22.04
    env:
      # å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹ï¼‰
      DEFCONFIG: vendor/sm8750-perf_defconfig
      KERNEL_REPO: https://github.com/OnePlusOSS/android_kernel_oneplus_sm8750.git
      LXC_PATCH_URL: https://raw.githubusercontent.com/yangxiaohua2009/lxc-android-kernel-patches/main/op13_sm8750_lxc.patch
      # è°·æ­Œå·¥å…·é“¾é…ç½®ï¼ˆå®‰å“14/15å®˜æ–¹ç¨³å®šç‰ˆï¼Œé€‚é…SM8750 6.6.xå†…æ ¸ï¼‰
      ANDROID_NDK_VERSION: r26b
      CLANG_VERSION: 17.0.2  # è°·æ­ŒNDK r26b å†…ç½®Clangç‰ˆæœ¬
      TOOLCHAIN_DIR: ./google-clang

    steps:
      ##########################################################################
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆæµ…å…‹éš†ï¼Œæé€Ÿï¼‰
      ##########################################################################
      - name: æ£€å‡ºåŸºç¡€ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      ##########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆè°·æ­Œå·¥å…·é“¾ä¾èµ– + å†…æ ¸ç¼–è¯‘å·¥å…·ï¼‰
      ##########################################################################
      - name: å®‰è£…Ubuntuç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y > /dev/null 2>&1
          sudo apt install -y \
            git bc bison flex libssl-dev libelf-dev lz4 zstd curl patch \
            python3 python3-pip openjdk-11-jdk-headless > /dev/null 2>&1
          echo -e "\033[32mâœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ\033[0m"

      ##########################################################################
      # æ­¥éª¤3ï¼šä¸‹è½½è°·æ­Œå®˜æ–¹ Android NDKï¼ˆå«Clangå·¥å…·é“¾ï¼‰
      ##########################################################################
      - name: ä¸‹è½½å¹¶è§£å‹è°·æ­ŒNDKï¼ˆå«Clangå·¥å…·é“¾ï¼‰
        run: |
          # è°·æ­ŒNDKå®˜æ–¹ä¸‹è½½é“¾æ¥ï¼ˆç¨³å®šç‰ˆï¼Œæ— é‡å®šå‘é—®é¢˜ï¼‰
          NDK_URL="https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip"
          mkdir -p "${TOOLCHAIN_DIR}"
          echo -e "\033[32mğŸ”½ å¼€å§‹ä¸‹è½½è°·æ­ŒNDKï¼ˆç‰ˆæœ¬ï¼š${ANDROID_NDK_VERSION}ï¼‰...\033[0m"

          # ä¸‹è½½NDKï¼ˆé‡è¯•5æ¬¡ï¼Œé—´éš”3ç§’ï¼Œè¶…æ—¶æ§åˆ¶ï¼‰
          curl -L --progress-bar \
            --retry 5 \
            --retry-delay 3 \
            --connect-timeout 60 \
            --max-time 300 \
            "${NDK_URL}" -o ./android-ndk.zip

          # æ ¡éªŒå‹ç¼©åŒ…å®Œæ•´æ€§ï¼ˆé€šè¿‡æ–‡ä»¶å¤§å°åˆæ­¥æ ¡éªŒï¼‰
          echo -e "\033[32mğŸ” æ ¡éªŒNDKå‹ç¼©åŒ…...\033[0m"
          NDK_EXPECTED_SIZE=1234567890  # NDK r26b å®é™…å¤§å°çº¦1.2GBï¼Œæ­¤å¤„ä¸ºå ä½ç¬¦ï¼Œå¯æ›¿æ¢ä¸ºçœŸå®å€¼
          NDK_ACTUAL_SIZE=$(stat -c%s ./android-ndk.zip)
          if [ $NDK_ACTUAL_SIZE -lt $((NDK_EXPECTED_SIZE * 0.9)) ]; then
            echo -e "\033[31mâŒ NDKå‹ç¼©åŒ…ä¸‹è½½ä¸å®Œæ•´ï¼Œé‡æ–°ä¸‹è½½...\033[0m"
            curl -L --progress-bar "${NDK_URL}" -o ./android-ndk.zip
          fi

          # è§£å‹NDKï¼ˆé™é»˜è§£å‹ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
          echo -e "\033[32mğŸ“¦ å¼€å§‹è§£å‹NDK...\033[0m"
          unzip -q ./android-ndk.zip -d "${TOOLCHAIN_DIR}"
          rm -f ./android-ndk.zip  # æ¸…ç†å‹ç¼©åŒ…

          # é…ç½®å·¥å…·é“¾è·¯å¾„ï¼ˆNDKå†…ç½®Clangè·¯å¾„ï¼‰
          export CLANG_PATH="${TOOLCHAIN_DIR}/android-ndk-${ANDROID_NDK_VERSION}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          echo "CLANG_PATH=${CLANG_PATH}" >> $GITHUB_ENV

          # éªŒè¯å·¥å…·é“¾å¯ç”¨æ€§
          echo -e "\033[32mâœ… å·¥å…·é“¾ç‰ˆæœ¬éªŒè¯...\033[0m"
          if ${CLANG_PATH}/clang --version | grep -q "version ${CLANG_VERSION}"; then
            echo -e "\033[32mâœ… è°·æ­ŒClangå·¥å…·é“¾å‡†å¤‡å®Œæˆï¼ˆç‰ˆæœ¬ï¼š${CLANG_VERSION}ï¼‰\033[0m"
          else
            echo -e "\033[31mâŒ è°·æ­ŒClangå·¥å…·é“¾éªŒè¯å¤±è´¥ï¼Œæ„å»ºç»ˆæ­¢ï¼\033[0m"
            exit 1
          fi
        shell: bash
        timeout-minutes: 15  # NDKä¸‹è½½+è§£å‹è¶…æ—¶é™åˆ¶ï¼ˆ15åˆ†é’Ÿï¼‰

      ##########################################################################
      # æ­¥éª¤4ï¼šæ‹‰å–ä¸€åŠ 13å®˜æ–¹å†…æ ¸æºç ï¼ˆæŒ‡å®šåˆ†æ”¯ï¼Œæµ…å…‹éš†ï¼‰
      ##########################################################################
      - name: æ‹‰å–ä¸€åŠ 13å†…æ ¸æºç 
        run: |
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'oneplus/sm8750_6.6.89' }}"
          echo -e "\033[32mğŸ“¥ æ‹‰å–å†…æ ¸æºç ï¼ˆåˆ†æ”¯ï¼š${KERNEL_BRANCH}ï¼‰...\033[0m"
          git clone -b "${KERNEL_BRANCH}" --depth 1 "${KERNEL_REPO}" ./op13_kernel
          cd ./op13_kernel
          echo -e "\033[32mâœ… å†…æ ¸æºç æ‹‰å–å®Œæˆï¼Œå½“å‰åˆ†æ”¯ï¼š$(git rev-parse --abbrev-ref HEAD)\033[0m"
        shell: bash
        timeout-minutes: 5

      ##########################################################################
      # æ­¥éª¤5ï¼šä¸‹è½½å¹¶åº”ç”¨LXCæ”¯æŒè¡¥ä¸ï¼ˆå…ˆæµ‹è¯•æ— å†²çªï¼Œå†åº”ç”¨ï¼‰
      ##########################################################################
      - name: åº”ç”¨LXCæ”¯æŒè¡¥ä¸
        run: |
          cd ./op13_kernel
          echo -e "\033[32mğŸ“¥ ä¸‹è½½LXCæ”¯æŒè¡¥ä¸...\033[0m"
          curl -L --progress-bar "${LXC_PATCH_URL}" -o lxc_support.patch

          echo -e "\033[32mğŸ” æµ‹è¯•è¡¥ä¸å…¼å®¹æ€§ï¼ˆæ— å†²çªå†åº”ç”¨ï¼‰...\033[0m"
          if patch -p1 --dry-run < lxc_support.patch > /dev/null 2>&1; then
            echo -e "\033[32mâœ… è¡¥ä¸æ— å†²çªï¼Œå¼€å§‹åº”ç”¨...\033[0m"
            patch -p1 < lxc_support.patch
            echo -e "\033[32mâœ… LXCè¡¥ä¸åº”ç”¨å®Œæˆ\033[0m"
          else
            echo -e "\033[31mâŒ è¡¥ä¸åº”ç”¨å†²çªï¼Œè¯·æ£€æŸ¥è¡¥ä¸ä¸å†…æ ¸åˆ†æ”¯å…¼å®¹æ€§ï¼\033[0m"
            exit 1
          fi
        shell: bash
        timeout-minutes: 2

      ##########################################################################
      # æ­¥éª¤6ï¼šé…ç½®ç¼–è¯‘ç¯å¢ƒå¹¶ç¼–è¯‘å†…æ ¸ï¼ˆè°·æ­Œå·¥å…·é“¾ + LXCæ”¯æŒï¼‰
      ##########################################################################
      - name: é…ç½®å¹¶ç¼–è¯‘å†…æ ¸
        run: |
          cd ./op13_kernel
          # å¯¼å…¥è°·æ­ŒClangå·¥å…·é“¾è·¯å¾„
          CLANG_PATH="${{ env.CLANG_PATH }}"

          # é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡ï¼ˆè°·æ­Œå·¥å…·é“¾æ ‡å‡†é…ç½®ï¼‰
          export ARCH=arm64
          export SUBARCH=arm64
          export CC="${CLANG_PATH}/aarch64-linux-android${CLANG_VERSION}-clang"
          export CXX="${CLANG_PATH}/aarch64-linux-android${CLANG_VERSION}-clang++"
          export LD="${CLANG_PATH}/ld.lld"
          export AR="${CLANG_PATH}/llvm-ar"
          export NM="${CLANG_PATH}/llvm-nm"
          export OBJCOPY="${CLANG_PATH}/llvm-objcopy"
          export OBJDUMP="${CLANG_PATH}/llvm-objdump"
          export STRIP="${CLANG_PATH}/llvm-strip"

          echo -e "\033[32mâš™ï¸  åŠ è½½å®˜æ–¹é…ç½®å¹¶åˆå¹¶LXCé…ç½®...\033[0m"
          make O=./build "${DEFCONFIG}"
          make O=./build olddefconfig  # è‡ªåŠ¨åˆå¹¶é…ç½®ï¼Œé¿å…å†²çª

          echo -e "\033[32mğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼ˆCPUæ ¸å¿ƒæ•°ï¼š$(nproc)ï¼‰...\033[0m"
          echo -e "\033[33mğŸ“ ç¼–è¯‘æ—¥å¿—å°†ä¿å­˜åˆ°ï¼š./op13_kernel/build/build.log\033[0m"
          make O=./build -j$(nproc) 2>&1 | tee ./build/build.log

          # æ ¡éªŒç¼–è¯‘äº§ç‰©æ˜¯å¦å­˜åœ¨
          if [ -f ./build/arch/arm64/boot/Image ]; then
            echo -e "\033[32mâœ… å†…æ ¸ç¼–è¯‘å®Œæˆï¼Œé•œåƒæ–‡ä»¶å·²ç”Ÿæˆ\033[0m"
          else
            echo -e "\033[31mâŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆé•œåƒæ–‡ä»¶ï¼\033[0m"
            exit 1
          fi
        shell: bash
        timeout-minutes: 60  # å†…æ ¸ç¼–è¯‘è¶…æ—¶é™åˆ¶ï¼ˆ60åˆ†é’Ÿï¼Œé€‚é…SM8750ï¼‰
        env:
          DEFCONFIG: ${{ env.DEFCONFIG }}

      ##########################################################################
      # æ­¥éª¤7ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©ï¼ˆå†…æ ¸é•œåƒ + æ¨¡å—æ‰“åŒ…ï¼‰
      ##########################################################################
      - name: æ•´ç†å¹¶å½’æ¡£äº§ç‰©
        run: |
          # åˆ›å»ºæœ€ç»ˆäº§ç‰©ç›®å½•
          mkdir -p ./final_output
          echo -e "\033[32mğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©...\033[0m"

          # å¤åˆ¶å†…æ ¸é•œåƒï¼ˆé‡å‘½åï¼Œä¾¿äºè¯†åˆ«ï¼‰
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || '6.6.89' }}"
          cp ./op13_kernel/build/arch/arm64/boot/Image ./final_output/OnePlus13_LXC_Kernel_GoogleClang_${KERNEL_BRANCH}.img

          # æ‰“åŒ…å†…æ ¸æ¨¡å—ï¼ˆLXCå®¹å™¨è¿è¡Œä¾èµ–ï¼‰
          if find ./op13_kernel/build -name "*.ko" | grep -q .; then
            find ./op13_kernel/build -name "*.ko" | xargs tar -zcf ./final_output/kernel_modules_lxc.tar.gz
            echo -e "\033[32mâœ… å†…æ ¸æ¨¡å—æ‰“åŒ…å®Œæˆ\033[0m"
          else
            echo -e "\033[33mâš ï¸  æœªæ‰¾åˆ°å†…æ ¸æ¨¡å—æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ç¼–è¯‘é…ç½®é—®é¢˜\033[0m"
          fi

          # è¾“å‡ºäº§ç‰©æ¸…å•
          echo -e "\033[32mâœ… äº§ç‰©æ•´ç†å®Œæˆï¼Œæ¸…å•å¦‚ä¸‹ï¼š\033[0m"
          ls -lh ./final_output/
        shell: bash

      ##########################################################################
      # æ­¥éª¤8ï¼šä¸Šä¼ äº§ç‰©åˆ°GitHub Actionsï¼ˆä¿ç•™90å¤©ï¼Œå¯ç›´æ¥ä¸‹è½½ï¼‰
      ##########################################################################
      - name: å½’æ¡£äº§ç‰©ä¾›ä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: ä¸€åŠ 13-LXCå†…æ ¸-è°·æ­Œå·¥å…·é“¾-${{ github.event.inputs.kernel_branch || '6.6.89' }}
          path: ./final_output/*
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©ï¼Œå¯æŒ‰éœ€è°ƒæ•´ï¼ˆ1-90ï¼‰
          if-no-files-found: error  # è‹¥äº§ç‰©ç¼ºå¤±ï¼Œæ„å»ºæ ‡è®°ä¸ºå¤±è´¥
          compression-level: 0  # å†…æ ¸é•œåƒä¸å‹ç¼©ï¼Œä¸‹è½½åå¯ç›´æ¥ä½¿ç”¨
