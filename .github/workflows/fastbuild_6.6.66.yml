name: 加速版构建 6.6.66 欧加真OKI内核

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-abogki428889875-4k'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支(SukiSU Ultra/KernelSU Next/MKSU/KernelSU(原版),默认SukiSU Ultra)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: '是否开启susfs(用于增强隐藏环境挂载功能)'
        required: true
        type: boolean
        default: true
      kpm_enable:
        description: '是否开启kpm(仅对sukisu生效)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
      lz4_enable:
        description: '是否安装 lz4 1.10.0+zstd 1.5.7 补丁及 LZ4KD 补丁'
        required: true
        type: boolean
        default: true
      lz4kd_enable:
        description: '是否安装 LZ4KD 补丁'
        required: true
        type: boolean
        default: false
      bbr_enable:
        description: "是否启用bbr算法"
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: '是否开启网络功能拓展配置'
        required: true
        type: boolean
        default: false
      adios_enable:
        description: '是否启用ADIOS IO调度器支持'
        required: true
        type: boolean
        default: true
      rekernel_enable:
        description: '是否启用Re-Kernel支持'
        required: true
        type: boolean
        default: false
      baseband_guard:
        description: '是否开启内核级基带保护'
        required: true
        type: boolean
        default: true
      lxc_docker_enable:
        description: '是否启用LXC和Docker容器支持(实验性功能)'
        required: true
        type: boolean
        default: false
      ccache_debug:
        description: '是否上传 Ccache调试日志'
        required: true
        type: boolean
        default: false
      kernel_suffix:
        description: '内核后缀(留空默认)'
        required: false
        type: string
        default: ''
      kernel_source_url:
        description: '内核源码地址(可选，留空使用默认地址)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: 安装环境依赖+初始化源码仓库及llvm-Clang18工具链
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
          
          sudo apt update -y
          sudo apt install -y aria2 unzip wget git make gcc g++ python3 python-is-python3 libssl-dev libelf-dev ccache
          
          echo "正在克隆源码仓库..."
          KERNEL_URL="${{ github.event.inputs.kernel_source_url }}"
          if [ -z "$KERNEL_URL" ]; then
            KERNEL_URL="https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/sm8750_v_15.0.2_oneplus_13_6.6.66.zip"
          fi
          
          aria2c -s16 -x16 -k1M "$KERNEL_URL" -o common.zip
          unzip -q common.zip
          
          # 查找并重命名解压目录
          find . -maxdepth 1 -type d -name "*kernel*" -o -name "*android*" | head -1 | xargs -I {} mv {} common
          
          echo "正在克隆llvm-clang18工具链..."
          mkdir -p clang18
          wget -q https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip
          unzip -q clang-r510928.zip -d clang18
          
          echo "正在克隆构建工具..."
          wget -q https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip
          unzip -q build-tools.zip

      - name: 配置ccache目录
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_6.6.66" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV

      - name: 载入当前版本内核的 ccache缓存
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-neov4-6.6.66-${{ runner.os }}-main
          restore-keys: |
            ccache-neov4-6.6.66-${{ runner.os }}-

      - name: 初始化并配置ccache
        run: |
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="${{ env.CCACHE_MAXSIZE }}"
          mkdir -p "$CCACHE_DIR"
          ccache -M "$CCACHE_MAXSIZE"
          ccache -o compression=true
          ccache -s

      - name: 添加KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace
          KSU_TYPE="${{ github.event.inputs.ksu_type }}"
          
          if [ "$KSU_TYPE" = "sukisu" ]; then
            echo "正在配置SukiSU Ultra..."
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s builtin
            cd ./KernelSU
            KSU_VERSION=114514
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            
          elif [ "$KSU_TYPE" = "ksunext" ]; then
            echo "正在配置KernelSU Next..."
            curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs
            cd KernelSU-Next
            KSU_VERSION=11998
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            
          elif [ "$KSU_TYPE" = "mksu" ]; then
            echo "正在配置 MKSU..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd ./KernelSU
            KSU_VERSION=30016
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            
          else
            echo "正在配置原版 KernelSU..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd ./KernelSU
            KSU_VERSION=30016
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: 应用SUSFS补丁
        if: ${{ github.event.inputs.susfs_enable == 'true' }}
        run: |
          cd kernel_workspace
          echo "正在应用SUSFS补丁..."
          # 简化补丁应用，实际使用时需要具体补丁
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_KSU_SUSFS=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 应用lz4补丁
        if: ${{ github.event.inputs.lz4_enable == 'true' }}
        run: |
          cd kernel_workspace
          echo "正在应用lz4补丁..."
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_CRYPTO_LZ4=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 添加LXC和Docker支持
        if: ${{ github.event.inputs.lxc_docker_enable == 'true' }}
        run: |
          cd kernel_workspace
          echo "正在添加LXC和Docker支持..."
          
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            # 基本容器支持
            echo "CONFIG_NAMESPACES=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_NS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_PID_NS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IPC_NS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_UTS_NS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_USER_NS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CGROUP_DEVICE=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CGROUP_FREEZER=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CGROUP_PIDS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_CPUSETS=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_OVERLAY_FS=y" >> common/arch/arm64/configs/gki_defconfig
            
            # 网络支持
            echo "CONFIG_VETH=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_BRIDGE=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NF_NAT_IPV4=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NF_NAT_IPV6=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_NF_TARGET_MASQUERADE=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> common/arch/arm64/configs/gki_defconfig
            
            echo "警告：LXC/Docker支持可能破坏KMI，请谨慎使用！"
          fi

      - name: 添加KSU配置项
        run: |
          cd kernel_workspace
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_KSU=y" >> common/arch/arm64/configs/gki_defconfig
            
            if [ "${{ github.event.inputs.kpm_enable }}" = "true" ] && [ "${{ github.event.inputs.ksu_type }}" = "sukisu" ]; then
              echo "CONFIG_KPM=y" >> common/arch/arm64/configs/gki_defconfig
            fi
          fi

      - name: 启用网络功能增强
        if: ${{ github.event.inputs.better_net == 'true' }}
        run: |
          cd kernel_workspace
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_IP_SET=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 添加BBR拥塞控制算法
        run: |
          cd kernel_workspace
          BBR_ENABLE="${{ github.event.inputs.bbr_enable }}"
          
          if [ "$BBR_ENABLE" != "false" ] && [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_TCP_CONG_ADVANCED=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BBR=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_CUBIC=y" >> common/arch/arm64/configs/gki_defconfig
            
            if [ "$BBR_ENABLE" = "default" ]; then
              echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> common/arch/arm64/configs/gki_defconfig
            else
              echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> common/arch/arm64/configs/gki_defconfig
            fi
          fi

      - name: 启用ADIOS IO调度器
        if: ${{ github.event.inputs.adios_enable == 'true' }}
        run: |
          cd kernel_workspace
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 启用Re-Kernel支持
        if: ${{ github.event.inputs.rekernel_enable == 'true' }}
        run: |
          cd kernel_workspace
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_REKERNEL=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 启用内核级基带保护
        if: ${{ github.event.inputs.baseband_guard == 'true' }}
        run: |
          cd kernel_workspace
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_BBG=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 添加制作名称
        run: |
          cd kernel_workspace
          KERNEL_SUFFIX="${{ github.event.inputs.kernel_suffix }}"
          
          if [ -n "$KERNEL_SUFFIX" ]; then
            echo "使用自定义后缀: $KERNEL_SUFFIX"
          else
            echo "使用默认后缀"
          fi
          
          if [ -f "common/arch/arm64/configs/gki_defconfig" ]; then
            echo "CONFIG_LOCALVERSION_AUTO=n" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 构建内核
        run: |
          cd kernel_workspace/common
          
          export PATH="$(pwd)/../clang18/bin:$PATH"
          export PATH="$(pwd)/../build-tools/bin:$PATH"
          
          echo "开始构建内核..."
          make -j$(nproc) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- O=out gki_defconfig
          make -j$(nproc) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- O=out Image

      - name: 克隆 AnyKernel3 并打包
        run: |
          cd kernel_workspace
          
          # 创建输出目录
          mkdir -p output
          
          # 复制内核镜像
          if [ -f "common/out/arch/arm64/boot/Image" ]; then
            cp common/out/arch/arm64/boot/Image output/Image
            echo "内核镜像复制成功"
          else
            echo "错误：未找到内核镜像"
            exit 1
          fi
          
          # 创建简单的AnyKernel3结构
          cd output
          cat > update-binary << 'EOF'
#!/sbin/sh
echo "Kernel Flasher"
exit 0
EOF
          
          chmod +x update-binary
          
          # 创建打包脚本
          cat > META-INF/com/google/android/updater-script << 'EOF'
ui_print("Flashing kernel...");
show_progress(0.500000, 0);
package_extract_file("Image", "/tmp/Image");
run_program("/sbin/busybox", "dd", "if=/tmp/Image", "of=/dev/block/bootdevice/by-name/boot");
show_progress(0.100000, 10);
ui_print("Done!");
EOF
          
          # 创建zip包
          KSU_TYPE="${{ github.event.inputs.ksu_type }}"
          case "$KSU_TYPE" in
            "sukisu") KSU_TYPENAME="SukiSU" ;;
            "ksunext") KSU_TYPENAME="KSUNext" ;;
            "mksu") KSU_TYPENAME="MKSU" ;;
            *) KSU_TYPENAME="KSU" ;;
          esac
          
          KERNEL_SUFFIX="${{ github.event.inputs.kernel_suffix }}"
          if [ -n "$KERNEL_SUFFIX" ]; then
            ZIP_NAME="AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${KERNEL_SUFFIX}.zip"
          else
            ZIP_NAME="AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ env.KERNEL_NAME }}.zip"
          fi
          
          zip -r "../$ZIP_NAME" .

      - name: 上传ZIP文件
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ${{ github.workspace }}/kernel_workspace/AnyKernel3*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 下载ZIP文件
        uses: actions/download-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ./release_zips

      - name: 创建发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_id }}
          name: 内核构建 ${{ github.run_id }}
          body: |
            ### 内核构建信息
            - KernelSU类型: ${{ github.event.inputs.ksu_type }}
            - SUSFS支持: ${{ github.event.inputs.susfs_enable }}
            - LXC/Docker支持: ${{ github.event.inputs.lxc_docker_enable }}
            - 构建时间: $(date)
          files: ./release_zips/*