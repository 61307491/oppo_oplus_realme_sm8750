name: 加速版构建 6.6.89 欧加真OKI内核

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-abogki428889875-4k'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支(SukiSU Ultra/KernelSU Next/MKSU/KernelSU(原版),默认SukiSU Ultra)'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: '是否开启susfs(用于增强隐藏环境挂载功能; 可能轻微增加耗电，上游更新导致不稳定时或不需要可关闭)'
        required: true
        type: boolean
        default: 'true'
      kpm_enable:
        description: '是否开启kpm(仅对sukisu生效; 可能轻微增加耗电，不需要可保持默认关闭)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
      lz4_enable:
        description: '是否安装 lz4 1.10.0+zstd 1.5.7 补丁及 LZ4KD 补丁'
        required: true
        type: boolean
        default: 'true'
      lz4kd_enable:
        description: '是否安装 LZ4KD 补丁(若已开启lz4+zstd补丁则可不开启)'
        required: true
        type: boolean
        default: 'false'
      bbr_enable:
        description: "是否启用bbr算法(优化上行数据,对手机日用无太大意义甚至可能负优化;false关闭,true仅加入算法,default启用算法并设为默认)"
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: '是否开启网络功能拓展配置(用于为ipset及需要iptables等高级网络功能内核支持的程序提供支持)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'true'
          - 'false'
      adios_enable:
        description: '是否启用ADIOS IO调度器支持(提升IO读写性能)'
        required: true
        type: boolean
        default: 'true'
      rekernel_enable:
        description: '是否启用Re-Kernel支持(与Freezer/NoActive等软件配合, 提升应用冻结能力)'
        required: true
        type: boolean
        default: 'false'
      baseband_guard:
        description: '是否开启内核级基带保护(阻止一切对非用户分区的写入，有效防止格机)'
        required: true
        type: boolean
        default: 'true'
      lxc_docker_enable:
        description: '是否开启LXC和Docker容器支持(提供完整的容器虚拟化功能，可运行Linux发行版容器，会增大内核体积)'
        required: true
        type: boolean
        default: 'false'
      ccache_debug:
        description: '是否上传 Ccache调试日志(用于调试, 无需要不必开启)'
        required: true
        type: boolean
        default: 'false'
      kernel_suffix:
        description: '内核后缀(留空默认,开头别加连字符,勿加空格等影响指令运行的保留字符)'
        required: false
        type: string
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: 安装环境依赖
        run: |
          sudo apt update
          sudo apt-get install -y --no-install-recommends \
            binutils \
            python3 \
            python-is-python3 \
            libssl-dev \
            libelf-dev \
            ccache \
            aria2 \
            curl \
            wget \
            git \
            unzip \
            bc \
            bison \
            flex \
            make

      - name: 初始化工作空间
        run: |
          rm -rf kernel_workspace
          mkdir -p kernel_workspace
          cd kernel_workspace

      - name: 下载内核源码（带重试机制）
        run: |
          cd kernel_workspace
          for i in {1..3}; do
            echo "尝试 $i/3 下载内核源码..."
            if aria2c -s16 -x16 -k1M \
              https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/sm8750_v_16.0.0_oneplus_13_6.6.89.zip \
              -o common.zip; then
              echo "下载成功"
              break
            fi
            echo "下载失败，等待10秒后重试..."
            sleep 10
            [ $i -eq 3 ] && echo "下载失败，退出构建" && exit 1
          done
          
          unzip -q common.zip
          mv "android_kernel_common_oneplus_sm8750-oneplus-sm8750_v_16.0.0_oneplus_13_6.6.89" common
          rm -f common.zip

      - name: 下载工具链
        run: |
          cd kernel_workspace
          mkdir -p clang18 build-tools
          
          # 下载clang
          for i in {1..3}; do
            echo "尝试 $i/3 下载clang工具链..."
            if aria2c -s16 -x16 -k1M \
              https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip \
              -o clang.zip; then
              echo "clang下载成功"
              break
            fi
            [ $i -eq 3 ] && echo "clang下载失败" && exit 1
            sleep 5
          done
          unzip -q clang.zip -d clang18
          rm -f clang.zip
          
          # 下载build-tools
          for i in {1..3}; do
            echo "尝试 $i/3 下载build-tools..."
            if aria2c -s16 -x16 -k1M \
              https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip \
              -o build-tools.zip; then
              echo "build-tools下载成功"
              break
            fi
            [ $i -eq 3 ] && echo "build-tools下载失败" && exit 1
            sleep 5
          done
          unzip -q build-tools.zip -d build-tools
          rm -f build-tools.zip

      - name: 清理ABI保护和dirty后缀
        run: |
          cd kernel_workspace/common
          # 去除ABI保护
          rm -f android/abi_gki_protected_exports_* 2>/dev/null || true
          # 去除dirty后缀
          if [ -f scripts/setlocalversion ]; then
            sed -i 's/ -dirty//g' scripts/setlocalversion
          fi

      - name: 配置ccache目录
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_6.6.89" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV

      - name: 载入ccache缓存
        uses: actions/cache@v4
        id: ccache-restore
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-neov4-6.6.89-${{ runner.os }}-main
          restore-keys: |
            ccache-neov4-6.6.89-${{ runner.os }}-
            ccache-neov4-6.6.89-

      - name: 初始化ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          ccache -M "${{ env.CCACHE_MAXSIZE }}"
          ccache -o compression=true
          echo "ccache初始状态:"
          ccache -s

      - name: 添加KernelSU
        id: ksu_version
        run: |
          cd kernel_workspace
          
          # 根据选择的KSU类型执行不同操作
          case "${{ github.event.inputs.ksu_type }}" in
            "sukisu")
              echo "正在配置SukiSU Ultra..."
              curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s susfs-main || {
                echo "SukiSU配置失败"
                exit 1
              }
              cd KernelSU
              KSU_VERSION=$(expr $(git rev-list --count HEAD 2>/dev/null) + 37185 2>/dev/null || echo 114514)
              ;;
            "ksunext")
              echo "正在配置KernelSU Next..."
              curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs || {
                echo "KernelSU Next配置失败"
                exit 1
              }
              cd KernelSU-Next
              KSU_VERSION=$(expr 10200 + $(date +%s) % 1000)
              ;;
            "mksu")
              echo "正在配置MKSU..."
              curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main || {
                echo "MKSU配置失败"
                exit 1
              }
              cd KernelSU
              KSU_VERSION=30000
              ;;
            *)
              echo "正在配置原版KernelSU..."
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main || {
                echo "KernelSU配置失败"
                exit 1
              }
              cd KernelSU
              KSU_VERSION=30000
              ;;
          esac
          
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
          echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT

      - name: 应用补丁（简化版）
        continue-on-error: true  # 补丁失败也不影响构建
        run: |
          cd kernel_workspace
          
          # SUSFS补丁
          if [[ "${{ github.event.inputs.susfs_enable }}" == "true" ]]; then
            echo "应用SUSFS补丁..."
            # 这里简化处理，实际需要根据你的补丁逻辑调整
            echo "CONFIG_KSU_SUSFS=y" >> common/arch/arm64/configs/gki_defconfig
          fi
          
          # LZ4补丁
          if [[ "${{ github.event.inputs.lz4_enable }}" == "true" ]]; then
            echo "启用LZ4配置..."
            echo "CONFIG_CRYPTO_LZ4=y" >> common/arch/arm64/configs/gki_defconfig
          fi
          
          # KPM配置
          if [[ "${{ github.event.inputs.kpm_enable }}" == "true" && "${{ github.event.inputs.ksu_type }}" == "sukisu" ]]; then
            echo "启用KPM配置..."
            echo "CONFIG_KPM=y" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 添加基础配置
        run: |
          cd kernel_workspace
          echo "CONFIG_KSU=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_HEADERS_INSTALL=n" >> common/arch/arm64/configs/gki_defconfig

      - name: 启用网络增强
        if: inputs.better_net
        run: |
          cd kernel_workspace
          cat >> common/arch/arm64/configs/gki_defconfig << 'EOF'
CONFIG_BPF_STREAM_PARSER=y
CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y
CONFIG_NETFILTER_XT_SET=y
CONFIG_IP_SET=y
CONFIG_IP_SET_MAX=65534
CONFIG_IP_SET_BITMAP_IP=y
CONFIG_IP_SET_HASH_IP=y
CONFIG_IP_SET_HASH_IPPORT=y
CONFIG_IP6_NF_NAT=y
CONFIG_IP6_NF_TARGET_MASQUERADE=y
EOF

      - name: 启用BBR算法
        if: inputs.bbr_enable != 'false'
        run: |
          cd kernel_workspace
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BBR=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_CUBIC=y" >> common/arch/arm64/configs/gki_defconfig
          if [[ "${{ github.event.inputs.bbr_enable }}" == "default" ]]; then
            echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> common/arch/arm64/configs/gki_defconfig
          else
            echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> common/arch/arm64/configs/gki_defconfig
          fi

      - name: 启用ADIOS调度器
        if: inputs.adios_enable
        run: |
          cd kernel_workspace
          echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> common/arch/arm64/configs/gki_defconfig

      - name: 启用Re-Kernel
        if: inputs.rekernel_enable
        run: |
          cd kernel_workspace
          echo "CONFIG_REKERNEL=y" >> common/arch/arm64/configs/gki_defconfig

      - name: 启用LXC和Docker支持
        if: inputs.lxc_docker_enable
        run: |
          cd kernel_workspace
          cat >> common/arch/arm64/configs/gki_defconfig << 'EOF'
# 容器基础支持
CONFIG_NAMESPACES=y
CONFIG_USER_NS=y
CONFIG_PID_NS=y
CONFIG_NET_NS=y
CONFIG_UTS_NS=y
CONFIG_IPC_NS=y
CONFIG_CGROUPS=y
CONFIG_CGROUP_CPUACCT=y
CONFIG_CGROUP_DEVICE=y
CONFIG_CGROUP_FREEZER=y
CONFIG_CGROUP_SCHED=y
CONFIG_CPUSETS=y
CONFIG_MEMCG=y
CONFIG_KEYS=y
# 网络支持
CONFIG_VETH=y
CONFIG_BRIDGE=y
CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y
CONFIG_IP_NF_NAT=y
CONFIG_NF_NAT=y
# 存储支持
CONFIG_OVERLAY_FS=y
CONFIG_BLK_DEV_DM=y
# 其他必要配置
CONFIG_TUN=y
CONFIG_BINFMT_MISC=y
CONFIG_POSIX_MQUEUE=y
CONFIG_FHANDLE=y
CONFIG_EVENTFD=y
CONFIG_EPOLL=y
EOF

      - name: 设置内核名称
        run: |
          cd kernel_workspace
          LOCAL_VERSION=""
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            LOCAL_VERSION="${{ github.event.inputs.kernel_suffix }}"
          else
            LOCAL_VERSION="${{ env.KERNEL_NAME }}"
          fi
          
          echo "CONFIG_LOCALVERSION=\"-$LOCAL_VERSION\"" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_LOCALVERSION_AUTO=n" >> common/arch/arm64/configs/gki_defconfig

      - name: 显示最终配置
        run: |
          cd kernel_workspace
          echo "=== 最终配置预览（最后20行） ==="
          tail -20 common/arch/arm64/configs/gki_defconfig

      - name: 构建内核（简化版）
        run: |
          cd kernel_workspace/common
          
          # 设置编译环境
          export PATH="/usr/lib/ccache:$PATH"
          export PATH="$(pwd)/../clang18/bin:$PATH"
          export PATH="$(pwd)/../build-tools/bin:$PATH"
          
          # 设置ccache
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="3G"
          ccache -M "$CCACHE_MAXSIZE"
          
          # 编译配置
          echo "开始配置内核..."
          make LLVM=1 ARCH=arm64 O=out gki_defconfig
          
          # 编译内核
          echo "开始编译内核..."
          make -j$(nproc) LLVM=1 ARCH=arm64 O=out \
            CC="ccache clang" \
            LD="ld.lld" \
            AR="llvm-ar" \
            NM="llvm-nm" \
            OBJCOPY="llvm-objcopy" \
            OBJDUMP="llvm-objdump" \
            STRIP="llvm-strip" \
            CROSS_COMPILE=aarch64-linux-gnu- \
            KCFLAGS="-O2 -Wno-error"
          
          # 检查编译结果
          if [ -f out/arch/arm64/boot/Image ]; then
            echo "内核编译成功！"
            ls -lh out/arch/arm64/boot/Image
          else
            echo "内核编译失败！"
            exit 1
          fi

      - name: 打包内核
        run: |
          cd kernel_workspace
          
          # 创建AnyKernel目录
          mkdir -p AnyKernel3
          cd AnyKernel3
          
          # 下载基础AnyKernel模板
          curl -L https://github.com/osm0sis/AnyKernel3/archive/master.zip -o anykernel.zip
          unzip -q anykernel.zip
          mv AnyKernel3-master/* .
          rm -rf AnyKernel3-master anykernel.zip
          
          # 复制内核镜像
          cp ../common/out/arch/arm64/boot/Image .
          
          # 创建更新脚本
          cat > update-binary << 'EOF'
#!/sbin/sh
#
# AnyKernel3 Installer
#

OUTFD=$1
ZIPFILE=$2

ui_print() { echo -e "ui_print $1\nui_print" > /proc/self/fd/$OUTFD; }

ui_print "正在安装内核..."

# 解压内核
dd if=$ZIPFILE of=/tmp/Image bs=1024 skip=1
cat /tmp/Image > /dev/block/bootdevice/by-name/boot

ui_print "安装完成！"
EOF
          
          chmod 755 update-binary
          
          # 确定文件名
          KSU_TYPE=""
          case "${{ github.event.inputs.ksu_type }}" in
            "sukisu") KSU_TYPE="SukiSU" ;;
            "ksunext") KSU_TYPE="KSUNext" ;;
            "mksu") KSU_TYPE="MKSU" ;;
            *) KSU_TYPE="KSU" ;;
          esac
          
          SUFFIX=""
          if [[ -n "${{ github.event.inputs.kernel_suffix }}" ]]; then
            SUFFIX="${{ github.event.inputs.kernel_suffix }}"
          else
            SUFFIX="${{ env.KERNEL_NAME }}"
          fi
          
          # 打包
          ZIP_NAME="AnyKernel3_${KSU_TYPE}_${{ env.KSUVER }}_6.6.89_A15_${SUFFIX}.zip"
          zip -r9 "../$ZIP_NAME" ./*
          
          echo "打包完成: $ZIP_NAME"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Build
          path: ${{ github.workspace }}/kernel_workspace/AnyKernel3_*.zip

  release:
    needs: build
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: 下载产物
        uses: actions/download-artifact@v4
        with:
          name: Kernel-Build
          path: ./artifacts

      - name: 创建发布
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_id }}-${{ github.run_attempt }}
          name: "内核构建 ${{ github.run_number }}"
          body: |
            ## 内核构建信息
            - 构建时间: $(date -u +"%Y-%m-%d %H:%M:%S")
            - KSU类型: ${{ github.event.inputs.ksu_type }}
            - SUSFS: ${{ github.event.inputs.susfs_enable }}
            - LXC/Docker: ${{ github.event.inputs.lxc_docker_enable }}
            - KPM: ${{ github.event.inputs.kpm_enable }}
            - BBR: ${{ github.event.inputs.bbr_enable }}
            
            ## 使用说明
            1. 通过Recovery刷入
            2. 或者使用KernelFlasher等工具刷入
            
            ## 注意事项
            - 刷机前请备份重要数据
            - 首次刷入建议清除缓存
          draft: false
          prerelease: false
          files: |
            artifacts/*.zip